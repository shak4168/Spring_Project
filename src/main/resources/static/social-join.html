<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>íšŒì›ê°€ì… ë§ˆë¬´ë¦¬</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body class="bg-light py-5">
    <div class="container" style="max-width: 500px;">
        <div class="card shadow border-0">
            <div class="card-body p-5">
                <h3 class="text-center fw-bold mb-4">ì¶”ê°€ ì •ë³´ ì…ë ¥</h3>
                <p class="text-center text-muted mb-4 small">
                    ì†Œì…œ ê³„ì •ì´ í™•ì¸ë˜ì—ˆìŠµë‹ˆë‹¤.<br>
                    ì„œë¹„ìŠ¤ ì´ìš©ì„ ìœ„í•´ ë‚˜ë¨¸ì§€ ì •ë³´ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.
                </p>

                <label class="form-label fw-bold">ê°€ì… ìœ í˜•</label>
                <div class="d-flex gap-2 mb-3">
                    <input type="radio" class="btn-check" name="role" id="roleUser" value="USER" checked>
                    <label class="btn btn-outline-primary flex-fill py-2" for="roleUser">ğŸ›’ êµ¬ë§¤ì</label>

                    <input type="radio" class="btn-check" name="role" id="roleSeller" value="SELLER">
                    <label class="btn btn-outline-success flex-fill py-2" for="roleSeller">ğŸ’¼ íŒë§¤ì</label>
                </div>

                <div class="mb-3">
                    <label for="phone" class="form-label fw-bold">ì „í™”ë²ˆí˜¸</label>
                    <input type="text" id="phone" class="form-control" placeholder="010-0000-0000">
                </div>

                <div class="mb-3">
                    <label class="form-label fw-bold">ì£¼ì†Œ</label>
                    <div class="input-group mb-2">
                        <input type="text" id="zipcode" class="form-control" placeholder="ìš°í¸ë²ˆí˜¸" readonly>
                        <button class="btn btn-outline-secondary" type="button" onclick="execDaumPostcode()">ê²€ìƒ‰</button>
                    </div>
                    <input type="text" id="address" class="form-control mb-2" placeholder="ê¸°ë³¸ ì£¼ì†Œ" readonly>
                    <input type="text" id="detailAddress" class="form-control" placeholder="ìƒì„¸ ì£¼ì†Œë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš” (ì˜ˆ: 101ë™ 101í˜¸)">
                </div>

                <button onclick="finishJoin()" class="btn btn-dark w-100 py-3 fw-bold mt-2">ê°€ì… ì™„ë£Œí•˜ê¸°</button>
            </div>
        </div>
    </div>

    <script src="//t1.daumcdn.net/mapjsapi/bundle/postcode/prod/postcode.v2.js"></script>
    
    <script>
        // 1. URLì— ìˆëŠ” í† í° ì €ì¥
        const urlParams = new URLSearchParams(window.location.search);
        const token = urlParams.get('token');
        if(token) localStorage.setItem('accessToken', token);

        // 2. ì¹´ì¹´ì˜¤ ì£¼ì†Œ ê²€ìƒ‰ í•¨ìˆ˜
        function execDaumPostcode() {
            new daum.Postcode({
                oncomplete: function(data) {
                    // íŒì—…ì—ì„œ ê²€ìƒ‰ê²°ê³¼ í•­ëª©ì„ í´ë¦­í–ˆì„ë•Œ ì‹¤í–‰í•  ì½”ë“œë¥¼ ì‘ì„±í•˜ëŠ” ë¶€ë¶„.
                    let addr = ''; // ì£¼ì†Œ ë³€ìˆ˜

                    // ì‚¬ìš©ìê°€ ì„ íƒí•œ ì£¼ì†Œ íƒ€ì…ì— ë”°ë¼ í•´ë‹¹ ì£¼ì†Œ ê°’ì„ ê°€ì ¸ì˜¨ë‹¤.
                    if (data.userSelectedType === 'R') { // ë„ë¡œëª… ì£¼ì†Œ
                        addr = data.roadAddress;
                    } else { // ì§€ë²ˆ ì£¼ì†Œ
                        addr = data.jibunAddress;
                    }

                    // ìš°í¸ë²ˆí˜¸ì™€ ì£¼ì†Œ ì •ë³´ë¥¼ í•´ë‹¹ í•„ë“œì— ë„£ëŠ”ë‹¤.
                    document.getElementById('zipcode').value = data.zonecode;
                    document.getElementById("address").value = addr;
                    // ìƒì„¸ì£¼ì†Œë¡œ í¬ì»¤ìŠ¤ ì´ë™
                    document.getElementById("detailAddress").focus();
                }
            }).open();
        }

        // 3. ê°€ì… ì™„ë£Œ ìš”ì²­
        async function finishJoin() {
            const role = document.querySelector('input[name="role"]:checked').value;
            const phone = document.getElementById('phone').value;
            const zipcode = document.getElementById('zipcode').value;
            const address = document.getElementById('address').value;
            const detailAddress = document.getElementById('detailAddress').value;

            // ìœ íš¨ì„± ê²€ì‚¬
            if(!phone) { alert("ì „í™”ë²ˆí˜¸ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”."); return; }
            if(!zipcode || !address) { alert("ì£¼ì†Œë¥¼ ê²€ìƒ‰í•´ì£¼ì„¸ìš”."); return; }

            const reqData = {
                role: role,
                phone: phone,
                zipcode: zipcode,
                address: address,
                detailAddress: detailAddress
            };

            try {
                const res = await fetch('/api/members/social-update', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': 'Bearer ' + localStorage.getItem('accessToken')
                    },
                    body: JSON.stringify(reqData)
                });

                if(res.ok) {
                    alert("ê°€ì…ì´ ì„±ê³µì ìœ¼ë¡œ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤! í™˜ì˜í•©ë‹ˆë‹¤.");
                    localStorage.setItem('role', role); // ì„ íƒí•œ ì—­í•  ë¡œì»¬ìŠ¤í† ë¦¬ì§€ ê°±ì‹ 
                    location.href = "/"; // ë©”ì¸ìœ¼ë¡œ ì´ë™
                } else {
                    alert("ê°€ì… ì²˜ë¦¬ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.");
                }
            } catch (e) {
                console.error(e);
                alert("ì„œë²„ í†µì‹  ì˜¤ë¥˜");
            }
        }
    </script>
</body>
</html>