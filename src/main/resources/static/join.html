<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>회원가입 - Cloud Native Shop</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        .container { max-width: 600px; margin-top: 50px; }
    </style>
</head>
<body class="bg-light py-5">
    <div class="container">
        <div class="card shadow border-0">
            <div class="card-body p-5">
                <h3 class="text-center mb-4 fw-bold">회원가입</h3>
                
                <h6 class="text-muted border-bottom pb-2 mb-3">필수 정보</h6>
                
                <div class="mb-3">
                    <label class="form-label">이메일 (아이디로 사용)</label>
                    <input type="email" id="joinEmail" class="form-control" placeholder="user@example.com">
                </div>

                <div class="mb-3">
                    <label class="form-label">비밀번호</label>
                    <input type="password" id="joinPw" class="form-control" placeholder="영문, 숫자, 특수문자 포함 8~20자">
                </div>

                <div class="mb-3">
                    <label class="form-label">이름</label>
                    <input type="text" id="joinName" class="form-control" placeholder="한글 2~5자 (예: 홍길동)">
                </div>

                <div class="mb-3">
                    <label class="form-label">생년월일</label>
                    <input type="text" id="birthDate" class="form-control" maxlength="8" placeholder="생년월일 8자리 (예: 19900101)" oninput="this.value = this.value.replace(/[^0-9]/g, '')">
                </div>

                <div class="mb-3">
                    <label class="form-label">휴대폰 번호</label>
                    <input type="text" id="joinPhone" class="form-control" placeholder="- 없이 숫자만 입력" oninput="this.value = this.value.replace(/[^0-9]/g, '')">
                </div>

                <h6 class="text-muted border-bottom pb-2 mb-3 mt-4">주소 정보 (선택)</h6>
                <div class="input-group mb-2">
                    <input type="text" id="zipcode" class="form-control" placeholder="우편번호" readonly>
                    <button class="btn btn-outline-primary" type="button" onclick="execDaumPostcode()">주소 찾기</button>
                </div>
                <div class="mb-2">
                    <input type="text" id="address" class="form-control" placeholder="기본 주소" readonly>
                </div>
                <div class="mb-4">
                    <input type="text" id="detailAddress" class="form-control" placeholder="상세 주소">
                </div>
                
                <button onclick="join()" class="btn btn-primary w-100 py-2 fw-bold">가입하기</button>
            </div>
        </div>
    </div>

    <script src="//t1.daumcdn.net/mapjsapi/bundle/postcode/prod/postcode.v2.js"></script>
    <script>
        // 1. 주소 찾기 함수
        function execDaumPostcode() {
            new daum.Postcode({
                oncomplete: function(data) {
                    var addr = data.userSelectedType === 'R' ? data.roadAddress : data.jibunAddress;
                    document.getElementById('zipcode').value = data.zonecode;
                    document.getElementById("address").value = addr;
                    document.getElementById("detailAddress").focus();
                }
            }).open();
        }

        // 2. 회원가입 요청 함수
        async function join() {
            const email = document.getElementById('joinEmail').value; 
            const password = document.getElementById('joinPw').value;
            const name = document.getElementById('joinName').value;
            const birthDate = document.getElementById('birthDate').value; 
            const phone = document.getElementById('joinPhone').value;
            
            // [변경됨] UI에서 선택하는 것이 아니라, 코드가 강제로 'USER'로 설정
            const role = 'USER'; 

            // 유효성 검사
            if (!email || !password || !name || !birthDate) {
                alert("필수 정보를 모두 입력해주세요.");
                return;
            }

            // 이메일 형식 체크
            // (admin 계정은 여기서 가입 안 하니까 엄격하게 체크해도 됩니다)
            const emailRegex = /^[a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\.[a-zA-Z]{2,}$/;
            if (!emailRegex.test(email)) {
                alert("올바른 이메일 형식이 아닙니다.");
                return;
            }
            
            const data = {
                email: email,       
                password: password,
                name: name,
                phone: phone, 
                birthDate: birthDate, 
                zipcode: document.getElementById('zipcode').value,
                address: document.getElementById('address').value,
                detailAddress: document.getElementById('detailAddress').value,
                role: role // 항상 'USER' 전송
            };

            try {
                const response = await fetch('/api/members/join', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });
                
                if (response.ok) {
                    alert("회원가입이 완료되었습니다!\n로그인 페이지로 이동합니다.");
                    window.location.href = "/login.html";
                } else {
                    const errorMsg = await response.text();
                    alert("가입 실패: " + errorMsg);
                }
            } catch (error) {
                console.error('Error:', error);
                alert("서버 통신 중 오류가 발생했습니다.");
            }
        }
    </script>
</body>
</html>