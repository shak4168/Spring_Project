<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>상품 상세 페이지</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        .page-link { cursor: pointer; }
    </style>
</head>
<body class="bg-light">

    <nav class="navbar navbar-expand-lg navbar-dark bg-dark mb-5">
        <div class="container">
            <a class="navbar-brand fw-bold" href="/">Shop</a>
        </div>
    </nav>

    <div class="container" id="detail-container">
        <div class="text-center py-5">
            <div class="spinner-border text-primary" role="status"></div>
            <p class="mt-2">상품 정보를 불러오는 중...</p>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    
    <script>
        const urlParams = new URLSearchParams(window.location.search);
        const itemId = urlParams.get('id');

        // [변경] 페이지 로드 시점
        document.addEventListener("DOMContentLoaded", () => {
            if (itemId) {
                // 1. 상품 정보 로드
                fetch(`/api/items/${itemId}`)
                    .then(res => {
                        if(!res.ok) throw new Error("상품 정보 로드 실패");
                        return res.json();
                    })
                    .then(data => {
                        renderDetail(data); // 상품 정보 그리기 (리뷰 컨테이너 생성됨)
                        loadReviews(0);     // [추가] 그 다음 리뷰 로드 시작!
                    })
                    .catch(err => {
                        console.error(err);
                        alert("상품 정보를 불러오지 못했습니다.");
                        window.location.href = '/';
                    });
            } else {
                alert("잘못된 접근입니다.");
                window.location.href = '/';
            }
        });

        // 1. 상품 상세 정보 그리기 (리뷰 로직 제거됨)
        function renderDetail(item) {
            const container = document.getElementById('detail-container');
            const imageUrl = item.imageUrl ? `/images/${item.imageUrl}` : 'https://dummyimage.com/600x600/dee2e6/6c757d.jpg';
            const stock = item.stockNumber !== undefined ? item.stockNumber : 0;

            const html = `
                <div class="row g-5">
                    <div class="col-md-6">
                        <div class="card border-0 shadow-sm">
                            <img src="${imageUrl}" class="card-img-top" alt="${item.name}" style="max-height: 500px; object-fit: cover;">
                        </div>
                    </div>

                    <div class="col-md-6">
                        <div class="badge bg-primary mb-2">NEW</div>
                        <h1 class="display-5 fw-bold">${item.name}</h1> 
                        <div class="fs-4 mb-4">
                            <span class="text-danger fw-bold">${item.price.toLocaleString()}</span>원
                        </div>
                        
                        <p class="lead text-muted">남은 수량: <strong>${stock}</strong>개</p>
                        
                        <div class="mb-3">
                            <span class="text-warning">★ ${item.averageRating ? item.averageRating.toFixed(1) : '0.0'}</span>
                            <small class="text-muted">(${item.reviewCount ? item.reviewCount : 0}개의 후기)</small>
                        </div>
                        
                        <hr class="my-4">

                        <div class="d-flex gap-3">
                            <input class="form-control text-center" id="quantity" type="number" value="1" min="1" max="${stock}" style="width: 100px;">
                            <button class="btn btn-outline-dark flex-shrink-0" type="button" onclick="addCart()">장바구니 담기</button>
                            <button class="btn btn-dark flex-shrink-0" type="button" onclick="orderItem()">바로 구매하기</button>
                        </div>
                    </div>
                </div>

                <div class="row mt-5">
                    <div class="col-12">
                        <div class="card shadow-sm border-0">
                            <div class="card-header bg-white">
                                <h5 class="mb-0">상품 상세 정보</h5>
                            </div>
                            <div class="card-body" style="min-height: 200px; white-space: pre-wrap;">${item.description}</div> 
                        </div>
                    </div>
                </div>

                <div class="row mt-5 mb-5">
                    <div class="col-12">
                        <h4 class="mb-3">구매 후기</h4>
                        <div id="review-list-container" class="list-group shadow-sm">
                            <div class="text-center py-5 text-muted">리뷰를 불러오는 중...</div>
                        </div>
                        
                        <nav aria-label="Page navigation" class="mt-4">
                            <ul class="pagination justify-content-center" id="pagination-container"></ul>
                        </nav>
                    </div>
                </div>
            `;
            container.innerHTML = html;
        }

        // 2. 리뷰 목록 로드 (Ajax)
        function loadReviews(page) {
        	console.log("1. 요청 보내는 상품 ID:", itemId); // [확인 1] 여기가 null이거나 이상한 숫자면 URL 문제
            fetch(`/api/reviews/${itemId}?page=${page}`)
                .then(res => res.json())
                .then(data => {
                	console.log("2. 서버 응답 데이터:", data); // [확인 2] content가 비어있는지 확인
                    renderReviews(data.content);
                    renderPagination(data);
                })
                .catch(err => console.error("리뷰 로드 실패", err));
        }

        // 3. 리뷰 렌더링
        function renderReviews(reviews) {
            const container = document.getElementById('review-list-container');
            if (!reviews || reviews.length === 0) {
                container.innerHTML = '<div class="list-group-item text-center p-5 text-muted">아직 작성된 리뷰가 없습니다.</div>';
                return;
            }

            let html = '';
            reviews.forEach(review => {
                // 답글(Reply) 처리
                let replyHtml = '';
                if (review.reply) { // DTO 필드명 확인 (ReviewResponseDTO의 reply)
                    replyHtml = `
                        <div class="mt-3 ms-4 p-3 bg-light rounded border-start border-3 border-primary">
                            <div class="d-flex justify-content-between mb-1">
                                <div>
                                    <span class="badge bg-primary me-2">판매자</span>
                                    <strong>${review.reply.writerName}</strong>
                                </div>
                                <small class="text-muted">${review.reply.regTime}</small>
                            </div>
                            <p class="mb-0 text-break">${review.reply.content}</p>
                        </div>
                    `;
                }

                html += `
                    <div class="list-group-item p-4 border-0 border-bottom">
                        <div class="d-flex w-100 justify-content-between mb-2">
                            <h6 class="mb-1 fw-bold">${review.writer}</h6>
                            <small class="text-muted">${review.regTime}</small>
                        </div>
                        <div class="text-warning mb-2">
                            ${'★'.repeat(review.rating)}${'☆'.repeat(5 - review.rating)}
                        </div>
                        <p class="mb-1 text-break">${review.content}</p>
                        ${replyHtml}
                    </div>
                `;
            });
            container.innerHTML = html;
        }

        // 4. [추가] 페이징 버튼 렌더링
        function renderPagination(pageData) {
            const container = document.getElementById('pagination-container');
            let html = '';
            
            // 페이지가 1개뿐이면 숨김
            if(pageData.totalPages <= 1) {
                container.innerHTML = '';
                return;
            }

            for(let i = 0; i < pageData.totalPages; i++) {
                const activeClass = (i === pageData.number) ? 'active' : '';
                html += `<li class="page-item ${activeClass}"><a class="page-link" href="#" onclick="loadReviews(${i}); return false;">${i + 1}</a></li>`;
            }
            container.innerHTML = html;
        }

        // [기존 함수 유지] 장바구니 & 주문
        function orderItem() {
            const token = localStorage.getItem('accessToken');
            if (!token) {
                alert("로그인이 필요한 서비스입니다.");
                window.location.href = '/login.html';
                return;
            }
            const quantityInput = document.getElementById('quantity');
            const count = parseInt(quantityInput.value);
            if (isNaN(count) || count < 1) {
                alert("최소 1개 이상 선택해야 합니다.");
                return;
            }
            const orderData = { itemId: itemId, count: count };

            fetch('/api/orders', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json', 'Authorization': 'Bearer ' + token },
                body: JSON.stringify(orderData)
            })
            .then(res => {
                if (res.status === 401) {
                    alert("세션이 만료되었습니다. 다시 로그인해주세요.");
                    window.location.href = '/login.html';
                    return;
                }
                if (!res.ok) return res.text().then(text => { throw new Error(text) });
                return res.text();
            })
            .then(msg => {
                alert(msg);
                window.location.href = '/';
            })
            .catch(err => {
                console.error(err);
                alert("주문 실패: " + err.message);
            });
        }
        
        function addCart() {
            const token = localStorage.getItem('accessToken');
            if (!token) {
                alert("로그인이 필요한 서비스입니다.");
                window.location.href = '/login.html';
                return;
            }
            const quantityInput = document.getElementById('quantity');
            const count = parseInt(quantityInput.value);
            if (count < 1) {
                alert("수량은 최소 1개 이상이어야 합니다.");
                return;
            }
            const cartData = { itemId: itemId, count: count };

            fetch('/api/cart', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json', 'Authorization': 'Bearer ' + token },
                body: JSON.stringify(cartData)
            })
            .then(res => {
                if (res.status === 401) {
                    alert("세션이 만료되었습니다.");
                    window.location.href = '/login.html';
                    return;
                }
                return res.text();
            })
            .then(msg => {
                if (confirm("장바구니에 담겼습니다. 이동하시겠습니까?")) {
                    window.location.href = '/cart.html';
                }
            })
            .catch(err => {
                console.error(err);
                alert("장바구니 담기 실패");
            });
        }
    </script>
</body>
</html>