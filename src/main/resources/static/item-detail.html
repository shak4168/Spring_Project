<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>상품 상세 페이지</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body class="bg-light">

    <nav class="navbar navbar-expand-lg navbar-dark bg-dark mb-5">
        <div class="container">
            <a class="navbar-brand fw-bold" href="/">Shop</a>
        </div>
    </nav>

    <div class="container" id="detail-container">
        <div class="text-center py-5">
            <div class="spinner-border text-primary" role="status"></div>
            <p class="mt-2">상품 정보를 불러오는 중...</p>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    
    <script>
        // 1. URL에서 ID 파싱 (?id=1) -> 전역 변수로 선언하여 어디서든 접근 가능하게 함
        const urlParams = new URLSearchParams(window.location.search);
        const itemId = urlParams.get('id');

        // 2. 페이지 로드 시 API 호출
        if (itemId) {
            fetch(`/api/items/${itemId}`)
                .then(res => {
                    if(!res.ok) throw new Error("통신 실패");
                    return res.json();
                })
                .then(data => {
                    renderDetail(data);
                })
                .catch(err => {
                    console.error(err);
                    alert("상품 정보를 불러오지 못했습니다.");
                    window.location.href = '/';
                });
        } else {
            alert("잘못된 접근입니다.");
            window.location.href = '/';
        }

        // 3. 화면 그리기 함수 (DTO 이름: name, description, imageUrl 사용)
        function renderDetail(item) {
            const container = document.getElementById('detail-container');
            
            // 이미지 경로 처리 (imageUrl 필드 사용)
            const imageUrl = item.imageUrl ? `/images/${item.imageUrl}` : 'https://dummyimage.com/600x600/dee2e6/6c757d.jpg';
            
            // 재고 수량 처리 (undefined 방지)
            const stock = item.stockNumber !== undefined ? item.stockNumber : 0;

            // 리뷰 HTML 생성 로직
            let reviewsHtml = '';
            if(item.reviews && item.reviews.length > 0) {
                item.reviews.forEach(review => {
                    // 답글(Reply) 처리
                    let repliesHtml = '';
                    if(review.replies && review.replies.length > 0) {
                        review.replies.forEach(reply => {
                            repliesHtml += `
                                <div class="mt-3 ms-5 p-3 bg-light rounded">
                                    <div class="d-flex justify-content-between">
                                        <div>
                                            <span class="badge bg-secondary me-2">판매자</span>
                                            <strong>${reply.writerName}</strong>
                                        </div>
                                        <small class="text-muted">${new Date(reply.regDate).toLocaleDateString()}</small>
                                    </div>
                                    <p class="mt-2 mb-0">${reply.content}</p>
                                </div>
                            `;
                        });
                    }

                    // 리뷰 아이템 조립
                    reviewsHtml += `
                        <div class="list-group-item p-4">
                            <div class="d-flex w-100 justify-content-between mb-2">
                                <h5 class="mb-1 fw-bold">${review.writerName}</h5>
                                <small class="text-muted">${new Date(review.regDate).toLocaleDateString()}</small>
                            </div>
                            <div class="text-warning mb-2">
                                ${'★'.repeat(review.rating)}${'☆'.repeat(5 - review.rating)}
                            </div>
                            <p class="mb-1">${review.content}</p>
                            ${repliesHtml}
                        </div>
                    `;
                });
            } else {
                reviewsHtml = '<div class="list-group-item text-center p-5 text-muted">아직 작성된 리뷰가 없습니다.</div>';
            }

            // 전체 HTML 조립 (DTO 이름: name, description 사용)
            const html = `
                <div class="row g-5">
                    <div class="col-md-6">
                        <div class="card border-0 shadow-sm">
                            <img src="${imageUrl}" class="card-img-top" alt="${item.name}" style="max-height: 500px; object-fit: cover;">
                        </div>
                    </div>

                    <div class="col-md-6">
                        <div class="badge bg-primary mb-2">NEW</div>
                        <h1 class="display-5 fw-bold">${item.name}</h1> 
                        <div class="fs-4 mb-4">
                            <span class="text-danger fw-bold">${item.price.toLocaleString()}</span>원
                        </div>
                        
                        <p class="lead text-muted">남은 수량: <strong>${stock}</strong>개</p>
                        
                        <hr class="my-4">

                        <div class="d-flex gap-3">
                            <input class="form-control text-center" id="quantity" type="number" value="1" min="1" max="${stock}" 
       style="width: 100px; padding: 5px;" />
                            <button class="btn btn-outline-dark flex-shrink-0" type="button" onclick="addCart()">장바구니 담기</button>
                            <button class="btn btn-dark flex-shrink-0" type="button" onclick="orderItem()">바로 구매하기</button>
                        </div>
                    </div>
                </div>

                <div class="row mt-5">
                    <div class="col-12">
                        <div class="card shadow-sm border-0">
                            <div class="card-header bg-white">
                                <h5 class="mb-0">상품 상세 정보</h5>
                            </div>
                            <div class="card-body" style="min-height: 200px; white-space: pre-wrap;">${item.description}</div> 
                        </div>
                    </div>
                </div>

                <div class="row mt-5 mb-5">
                    <div class="col-12">
                        <h4 class="mb-3">구매 후기 (${item.reviews ? item.reviews.length : 0})</h4>
                        <div class="list-group shadow-sm">
                            ${reviewsHtml}
                        </div>
                    </div>
                </div>
            `;
            
            container.innerHTML = html;
        }
        
        // 4. [주문하기 함수] - renderDetail 밖으로 이동하여 전역에서 호출 가능하도록 수정
        function orderItem() {
            // 1. 토큰 확인 (로그인 여부 체크)
            const token = localStorage.getItem('accessToken');
            if (!token) {
                alert("로그인이 필요한 서비스입니다.");
                window.location.href = '/login.html'; // 로그인 페이지로 리다이렉트
                return;
            }

            // 2. 보낼 데이터 준비 및 유효성 검사
            const quantityInput = document.getElementById('quantity');
            const count = parseInt(quantityInput.value);
            
            if (isNaN(count) || count < 1) {
                alert("최소 1개 이상 선택해야 합니다.");
                return;
            }

            const orderData = {
                itemId: itemId, // URL에서 파싱한 그 ID
                count: count
            };

            // 3. API 호출 (POST /api/orders)
            fetch('/api/orders', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': 'Bearer ' + token // 토큰 실어 보내기
                },
                body: JSON.stringify(orderData)
            })
            .then(res => {
                if (res.status === 401) { // 토큰 만료되거나 문제 생김
                    alert("로그인 세션이 만료되었습니다. 다시 로그인해주세요.");
                    window.location.href = '/login.html';
                    return;
                }
                if (!res.ok) {
                    // 재고 부족 등의 에러 메시지 처리 (서버에서 보낸 메시지 출력)
                    return res.text().then(text => { throw new Error(text) });
                }
                return res.text();
            })
            .then(msg => {
                // 성공 메시지 출력
                if(msg) {
                    alert(msg); // "주문이 완료되었습니다!"
                    window.location.href = '/'; // 메인으로 이동
                }
            })
            .catch(err => {
                console.error(err);
                alert("주문 실패: " + err.message);
            });
        }
        
     // 장바구니 담기 함수
        function addCart() {
            // 1. 로그인 체크
            const token = localStorage.getItem('accessToken');
            if (!token) {
                alert("로그인이 필요한 서비스입니다.");
                window.location.href = '/login.html';
                return;
            }

            // 2. 수량 체크
            const quantityInput = document.getElementById('quantity');
            const count = parseInt(quantityInput.value);
            if (count < 1) {
                alert("수량은 최소 1개 이상이어야 합니다.");
                return;
            }

            // 3. API 전송
            const cartData = {
                itemId: itemId,
                count: count
            };

            fetch('/api/cart', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': 'Bearer ' + token
                },
                body: JSON.stringify(cartData)
            })
            .then(res => {
                if (res.status === 401) {
                    alert("세션이 만료되었습니다. 다시 로그인해주세요.");
                    window.location.href = '/login.html';
                    return;
                }
                return res.text();
            })
            .then(msg => {
                // 4. 성공 시 사용자에게 묻기
                if (confirm("장바구니에 담겼습니다. 장바구니로 이동하시겠습니까?")) {
                    window.location.href = '/cart.html'; // (아직 안 만듦, 다음 단계에서 제작)
                }
                // '취소'를 누르면 현재 페이지에 머무름 (쇼핑 계속하기)
            })
            .catch(err => {
                console.error(err);
                alert("장바구니 담기 실패");
            });
        }
    </script>
</body>
</html>