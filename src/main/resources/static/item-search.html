<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>ìƒí’ˆ ëª©ë¡ - Cloud Shop</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css">
</head>
<body>

    <nav class="navbar navbar-expand-lg navbar-dark bg-dark sticky-top">
        <div class="container">
            <a class="navbar-brand fw-bold" href="/"><i class="bi bi-shop"></i> Cloud Shop</a>
            
            <div class="d-flex ms-auto">
                <div class="input-group">
                    <input type="text" id="searchInput" class="form-control form-control-sm" 
                           placeholder="ìƒí’ˆ ê²€ìƒ‰" onkeyup="if(window.event.keyCode==13){searchItem()}">
                    <button class="btn btn-primary btn-sm" type="button" onclick="searchItem()">ê²€ìƒ‰</button>
                </div>
            </div>
        </div>
    </nav>

    <div class="container mt-5">
        <h2 class="fw-bold mb-4" id="page-title">
            ìƒí’ˆ ëª©ë¡
        </h2>

        <div id="search-result-list" class="row row-cols-1 row-cols-md-3 row-cols-lg-4 g-4">
            </div>
        
        <div id="no-result" class="text-center py-5 d-none">
            <i class="bi bi-exclamation-circle fs-1 text-secondary"></i>
            <p class="mt-3 text-secondary fs-5">ë“±ë¡ëœ ìƒí’ˆì´ ì—†ìŠµë‹ˆë‹¤.</p>
            <a href="/" class="btn btn-outline-dark mt-2">ë©”ì¸ìœ¼ë¡œ ëŒì•„ê°€ê¸°</a>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    
    <script>
        // 1. ê²€ìƒ‰ í•¨ìˆ˜ (ì—”í„°í‚¤ ì²˜ë¦¬ í¬í•¨)
        function searchItem() {
            const keyword = document.getElementById('searchInput').value;
            if (!keyword.trim()) {
                alert("ê²€ìƒ‰ì–´ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”!");
                return;
            }
            // ê²€ìƒ‰ ê²°ê³¼ í˜ì´ì§€ë¡œ ì´ë™ (í‚¤ì›Œë“œ íŒŒë¼ë¯¸í„° í¬í•¨)
            location.href = `/item-search.html?keyword=${encodeURIComponent(keyword)}`;
        }

        document.addEventListener("DOMContentLoaded", () => {
            // 2. URL íŒŒë¼ë¯¸í„° ë¶„ì„ (ê²€ìƒ‰ì–´? ì¹´í…Œê³ ë¦¬? ì „ì²´?)
            const params = new URLSearchParams(window.location.search);
            const keyword = params.get('keyword');
            const categoryId = params.get('categoryId');
            const categoryName = params.get('categoryName');

            // ê²€ìƒ‰ì°½ì— í˜„ì¬ ê²€ìƒ‰ì–´ ìœ ì§€ (ì‚¬ìš©ì í¸ì˜ì„±)
            if (keyword) {
                document.getElementById('searchInput').value = keyword;
            }

            // 3. ìƒí™©ë³„ API í˜¸ì¶œ ë¶„ê¸°
            if (keyword) {
                // [CASE 1] ê²€ìƒ‰ ëª¨ë“œ
                document.getElementById('page-title').innerHTML = `ğŸ” "<span class="text-primary">${keyword}</span>" ê²€ìƒ‰ ê²°ê³¼`;
                loadItems(`/api/items/search?keyword=${encodeURIComponent(keyword)}&size=20`);
            } 
            else if (categoryId) {
                // [CASE 2] ì¹´í…Œê³ ë¦¬ ëª¨ë“œ
                const title = categoryName ? categoryName : "ì¹´í…Œê³ ë¦¬ ìƒí’ˆ";
                document.getElementById('page-title').innerText = `ğŸ“‚ ${title}`;
                loadItems(`/api/items?categoryId=${categoryId}&page=0&size=20`);
            } 
            else {
                // [CASE 3] ì „ì²´ ë³´ê¸° ëª¨ë“œ
                document.getElementById('page-title').innerText = "ğŸ”¥ ì „ì²´ ìƒí’ˆ ëª©ë¡";
                loadItems(`/api/items?page=0&size=20`);
            }
        });

        // 4. ìƒí’ˆ ëª©ë¡ ë¶ˆëŸ¬ì˜¤ê¸° (ê³µí†µ í•¨ìˆ˜)
        function loadItems(apiUrl) {
            fetch(apiUrl)
                .then(res => {
                    if(!res.ok) throw new Error("API Load Failed");
                    return res.json();
                })
                .then(data => {
                    const container = document.getElementById('search-result-list');
                    container.innerHTML = ""; // ì´ˆê¸°í™”
                    
                    const items = data.content; // Page<ItemResponseDTO>ì˜ content

                    if (items.length === 0) {
                        document.getElementById('no-result').classList.remove('d-none');
                        return;
                    }

                    // ì¹´ë“œ ë Œë”ë§
                    items.forEach(item => {
                        // ì´ë¯¸ì§€ê°€ ì—†ìœ¼ë©´ ë”ë¯¸ ì´ë¯¸ì§€ ì‚¬ìš©
                        const imgUrl = item.imageUrl ? `/images/${item.imageUrl}` : 'https://dummyimage.com/600x400/dee2e6/6c757d.jpg';
                        
                        const html = `
                            <div class="col">
                                <div class="card h-100 shadow-sm border-0" onclick="location.href='/item-detail.html?id=${item.id}'" style="cursor:pointer; transition: transform 0.2s;">
                                    <img src="${imgUrl}" class="card-img-top" alt="${item.name}" style="height: 200px; object-fit: cover;">
                                    <div class="card-body">
                                        <h5 class="card-title fw-bold text-truncate">${item.name}</h5>
                                        <p class="card-text text-danger fw-bold fs-5">${item.price.toLocaleString()}ì›</p>
                                    </div>
                                </div>
                            </div>
                        `;
                        container.insertAdjacentHTML('beforeend', html);
                    });
                    
                    // (ì˜µì…˜) ì¹´ë“œ í˜¸ë²„ íš¨ê³¼ ì¶”ê°€
                    document.querySelectorAll('.card').forEach(card => {
                        card.addEventListener('mouseenter', () => card.style.transform = 'scale(1.03)');
                        card.addEventListener('mouseleave', () => card.style.transform = 'scale(1)');
                    });
                })
                .catch(err => {
                    console.error("Error:", err);
                    document.getElementById('search-result-list').innerHTML = '<div class="text-center w-100"><p class="text-danger">ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.</p></div>';
                });
        }
    </script>
</body>
</html>