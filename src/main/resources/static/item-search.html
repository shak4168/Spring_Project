<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>ìƒí’ˆ ëª©ë¡ - Cloud Shop</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css">
    <style>
        .card:hover { transform: translateY(-5px); box-shadow: 0 .5rem 1rem rgba(0,0,0,.15)!important; }
        .page-link { cursor: pointer; }
    </style>
</head>
<body class="bg-light">

    <nav class="navbar navbar-expand-lg navbar-dark bg-dark sticky-top shadow-sm">
        <div class="container">
            <a class="navbar-brand fw-bold" href="/"><i class="bi bi-cloud-check"></i> Cloud Shop</a>
            <div class="d-flex ms-auto">
                <div class="input-group">
                    <input type="text" id="searchInput" class="form-control form-control-sm" 
                           placeholder="ìƒí’ˆ ê²€ìƒ‰" onkeyup="if(window.event.keyCode==13){searchItem()}">
                    <button class="btn btn-primary btn-sm" type="button" onclick="searchItem()">ê²€ìƒ‰</button>
                </div>
            </div>
        </div>
    </nav>

    <div class="container mt-5 mb-5">
        <h3 class="fw-bold mb-4 border-bottom pb-2" id="page-title">
            ìƒí’ˆ ëª©ë¡
        </h3>

        <div id="search-result-list" class="row row-cols-1 row-cols-md-3 row-cols-lg-4 g-4">
            </div>
        
        <div id="no-result" class="text-center py-5 d-none">
            <i class="bi bi-exclamation-circle display-1 text-secondary opacity-50"></i>
            <p class="mt-3 text-secondary fs-5">ë“±ë¡ëœ ìƒí’ˆì´ ì—†ìŠµë‹ˆë‹¤.</p>
            <a href="/" class="btn btn-outline-dark mt-2">ë©”ì¸ìœ¼ë¡œ ëŒì•„ê°€ê¸°</a>
        </div>

        <div id="pagination-wrapper" class="d-flex justify-content-center mt-5 d-none">
            <button id="btn-prev" class="btn btn-outline-secondary me-2" onclick="prevPage()">ì´ì „</button>
            <span class="align-self-center px-3 fw-bold text-primary" id="page-indicator">1</span>
            <button id="btn-next" class="btn btn-outline-secondary ms-2" onclick="nextPage()">ë‹¤ìŒ</button>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    
   <script>
    // ==========================================
    // ì „ì—­ ë³€ìˆ˜: í˜ì´ì§€ ìƒíƒœ ê´€ë¦¬
    // ==========================================
    let currentPage = 0;
    let totalPages = 0; // [ì¶”ê°€] ì „ì²´ í˜ì´ì§€ ìˆ˜ë¥¼ ì €ì¥í•´ì„œ ì•ˆì „ì¥ì¹˜ë¡œ ì‚¬ìš©
    
    // í˜„ì¬ ëª¨ë“œ ì €ì¥ (search: ê²€ìƒ‰, category: ì¹´í…Œê³ ë¦¬, all: ì „ì²´)
    let currentMode = 'all'; 
    let currentQuery = ''; 

    // ==========================================
    // 1. ì´ˆê¸° ì‹¤í–‰ (URL íŒŒë¼ë¯¸í„° ë¶„ì„)
    // ==========================================
    document.addEventListener("DOMContentLoaded", () => {
        const params = new URLSearchParams(window.location.search);
        const keyword = params.get('keyword');
        const categoryId = params.get('categoryId');
        const categoryName = params.get('categoryName');

        if (keyword) {
            currentMode = 'search';
            currentQuery = keyword;
            document.getElementById('searchInput').value = keyword;
            document.getElementById('page-title').innerHTML = `ğŸ” "<span class="text-primary">${keyword}</span>" ê²€ìƒ‰ ê²°ê³¼`;
        } 
        else if (categoryId) {
            currentMode = 'category';
            currentQuery = categoryId;
            const title = categoryName ? categoryName : "ì¹´í…Œê³ ë¦¬ ìƒí’ˆ";
            document.getElementById('page-title').innerText = `ğŸ“‚ ${title}`;
        } 
        else {
            currentMode = 'all';
            document.getElementById('page-title').innerText = "ğŸ”¥ ì „ì²´ ìƒí’ˆ ëª©ë¡";
        }

        // ì²« í˜ì´ì§€ ë¡œë“œ
        loadItems(0);
    });

    // ==========================================
    // 2. ë°ì´í„° ë¡œë“œ (NaN ë°©ì§€ + í˜ì´ì§€ ë²”ìœ„ ì²´í¬)
    // ==========================================
    async function loadItems(page) {
        // [ì¤‘ìš”] í•œ í˜ì´ì§€ë‹¹ ë³´ì—¬ì¤„ ê°œìˆ˜ (12ê°œê°€ ì¹´ë“œ ë ˆì´ì•„ì›ƒì— ìµœì )
        const size = 12; 
        
        let url = '';
        if (currentMode === 'search') {
            url = `/api/items/search?keyword=${encodeURIComponent(currentQuery)}&page=${page}&size=${size}`;
        } else if (currentMode === 'category') {
            url = `/api/items?categoryId=${currentQuery}&page=${page}&size=${size}`;
        } else {
            url = `/api/items?page=${page}&size=${size}`;
        }

        try {
            const res = await fetch(url);
            if(!res.ok) throw new Error("API Error");
            const data = await res.json();

            const container = document.getElementById('search-result-list');
            const noResult = document.getElementById('no-result');
            const pagination = document.getElementById('pagination-wrapper');

            container.innerHTML = "";

            // ë°ì´í„°ê°€ ì•„ì˜ˆ ì—†ê±°ë‚˜ contentê°€ ë¹„ì–´ìˆì„ ë•Œ
            if (!data.content || data.content.length === 0) {
                noResult.classList.remove('d-none');
                pagination.classList.add('d-none'); // ë²„íŠ¼ ìˆ¨ê¹€
                return;
            } else {
                noResult.classList.add('d-none');
            }

            // [ê¶Œí•œ í™•ì¸] ê´€ë¦¬ìë©´ ì‚­ì œ ë²„íŠ¼ ë³´ì´ê¸°
            const currentRole = localStorage.getItem('role');
            
            data.content.forEach(item => {
                const imgUrl = item.imageUrl ? `/images/${item.imageUrl}` : 'https://dummyimage.com/600x400/dee2e6/6c757d.jpg';
                
                let adminBtn = '';
                if (currentRole === 'ADMIN') {
                    adminBtn = `<button class="btn btn-sm btn-danger position-absolute top-0 end-0 m-2 shadow-sm" 
                                onclick="deleteItem(event, ${item.id})" title="ê´€ë¦¬ì ì‚­ì œ"><i class="bi bi-trash"></i></button>`;
                }

                // í’ˆì ˆ ë±ƒì§€
                let statusBadge = '';
                if (item.itemSellStatus === 'SOLD_OUT' || item.stockNumber <= 0) {
                    statusBadge = `<span class="badge bg-secondary position-absolute top-0 start-0 m-2 shadow-sm">í’ˆì ˆ</span>`;
                } else {
                    statusBadge = `<span class="badge bg-primary position-absolute top-0 start-0 m-2 shadow-sm">íŒë§¤ì¤‘</span>`;
                }

                const html = `
                    <div class="col">
                        <div class="card h-100 shadow-sm border-0 position-relative" 
                             onclick="location.href='/item-detail.html?id=${item.id}'" 
                             style="cursor:pointer;">
                            ${adminBtn}
                            ${statusBadge}
                            <img src="${imgUrl}" class="card-img-top" alt="${item.name}" style="height: 200px; object-fit: cover;">
                            <div class="card-body d-flex flex-column">
                                <h5 class="card-title fs-6 fw-bold text-truncate">${item.itemName || item.name}</h5>
                                <div class="mt-auto">
                                    <p class="card-text text-danger fw-bold fs-5 mb-0">${item.price.toLocaleString()}ì›</p>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
                container.insertAdjacentHTML('beforeend', html);
            });

            // 3. í˜ì´ì§€ë„¤ì´ì…˜ ì²˜ë¦¬ (ì—¬ê¸°ê°€ í•µì‹¬!)
            
            // ì „ì²´ í˜ì´ì§€ê°€ 1ê°œ ì´í•˜ë©´ ë²„íŠ¼ ìˆ¨ê¹€
            if (data.totalPages <= 1) {
                pagination.classList.add('d-none');
            } else {
                pagination.classList.remove('d-none');
                
                // [ì•ˆì „ì¥ì¹˜ 1] NaN ë°©ì§€
                currentPage = (typeof data.number !== 'undefined') ? data.number : 0;
                totalPages = data.totalPages; // ì „ì²´ í˜ì´ì§€ ìˆ˜ ì €ì¥

                // [ì•ˆì „ì¥ì¹˜ 2] ë²„íŠ¼ í™œì„±í™”/ë¹„í™œì„±í™” (UI)
                document.getElementById('page-indicator').innerText = currentPage + 1;
                document.getElementById('btn-prev').disabled = data.first; // ì²« í˜ì´ì§€ë©´ 'ì´ì „' ë”
                document.getElementById('btn-next').disabled = data.last;  // ë§ˆì§€ë§‰ í˜ì´ì§€ë©´ 'ë‹¤ìŒ' ë”
            }

        } catch (err) {
            console.error("Error:", err);
        }
    }

    // ==========================================
    // 3. í˜ì´ì§€ ì´ë™ í•¨ìˆ˜ (ê°•ë ¥í•œ ë°©ì–´ ì½”ë“œ)
    // ==========================================
    function prevPage() { 
        if (currentPage > 0) {
            loadItems(currentPage - 1); 
        }
    }
    
    function nextPage() { 
        // [í•µì‹¬] í˜„ì¬ í˜ì´ì§€ê°€ (ì „ì²´ í˜ì´ì§€ - 1)ë³´ë‹¤ ì‘ì„ ë•Œë§Œ ì´ë™ ê°€ëŠ¥
        // ì˜ˆ: ì „ì²´ 5í˜ì´ì§€(0~4)ì¼ ë•Œ, í˜„ì¬ê°€ 3ì´ë©´ 4ë¡œ ê°ˆ ìˆ˜ ìˆìŒ. 4ë©´ ëª» ê°.
        if (currentPage < totalPages - 1) { 
            loadItems(currentPage + 1); 
        }
    }

    function searchItem() {
        const keyword = document.getElementById('searchInput').value;
        if (!keyword.trim()) {
            alert("ê²€ìƒ‰ì–´ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”!");
            return;
        }
        location.href = `/item-search.html?keyword=${encodeURIComponent(keyword)}`;
    }

    async function deleteItem(event, itemId) {
        event.stopPropagation(); 
        if(!confirm('ê´€ë¦¬ì ê¶Œí•œìœ¼ë¡œ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;

        const token = localStorage.getItem('accessToken');
        try {
            const res = await fetch(`/api/admin/items/${itemId}`, {
                method: 'DELETE',
                headers: { 'Authorization': 'Bearer ' + token }
            });
            if(res.ok) {
                alert('ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.');
                location.reload();
            } else {
                alert('ì‚­ì œ ì‹¤íŒ¨');
            }
        } catch (e) { console.error(e); }
    }
</script>
</body>
</html>