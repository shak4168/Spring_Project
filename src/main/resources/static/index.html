<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Cloud Native Shop</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css">
    
    <style>
        .hero-section {
            background: linear-gradient(rgba(0,0,0,0.5), rgba(0,0,0,0.5)), url('https://images.unsplash.com/photo-1472851294608-415522f96319?ixlib=rb-4.0.3&auto=format&fit=crop&w=1600&q=80');
            background-size: cover;
            background-position: center;
            color: white;
            padding: 80px 0;
            margin-bottom: 30px;
        }

        /* â˜… ê°€ë¡œ ìŠ¤í¬ë¡¤ í•µì‹¬ CSS â˜… */
        .scrolling-wrapper {
            display: flex;
            flex-wrap: nowrap;
            overflow-x: auto;
            -webkit-overflow-scrolling: touch; /* ëª¨ë°”ì¼ ë¶€ë“œëŸ¬ìš´ ìŠ¤í¬ë¡¤ */
            scroll-behavior: smooth;
            padding-bottom: 10px; /* ìŠ¤í¬ë¡¤ë°” ê³µê°„ í™•ë³´ */
            gap: 15px; /* ì¹´ë“œ ì‚¬ì´ ê°„ê²© */
        }

        /* ìŠ¤í¬ë¡¤ë°” ìˆ¨ê¸°ê¸° (ì„ íƒì‚¬í•­ - ê¹”ë”í•˜ê²Œ ë³´ì´ë ¤ë©´ ì ìš©) */
        .scrolling-wrapper::-webkit-scrollbar {
            height: 8px;
        }
        .scrolling-wrapper::-webkit-scrollbar-thumb {
            background: #ccc;
            border-radius: 4px;
        }
        .scrolling-wrapper::-webkit-scrollbar-track {
            background: transparent;
        }

        .card-block {
            flex: 0 0 auto; /* ì¹´ë“œ í¬ê¸° ê³ ì • (ì¤„ì–´ë“¤ì§€ ì•ŠìŒ) */
            width: 250px;   /* ì¹´ë“œ ë„ˆë¹„ ì„¤ì • */
        }

        .card-img-top {
            height: 180px;
            object-fit: cover;
        }
        
        .product-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 4px 15px rgba(0,0,0,0.1) !important;
            transition: all 0.2s;
        }

        .section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            margin-top: 40px;
            padding-bottom: 10px;
            border-bottom: 1px solid #eee;
        }
        
        .view-all-btn {
            font-size: 0.9rem;
            text-decoration: none;
            color: #666;
            cursor: pointer;
        }
        .view-all-btn:hover { color: #000; }
    </style>
</head>
<body>
    <nav class="navbar navbar-expand-lg navbar-dark bg-dark sticky-top">
        <div class="container">
            <a class="navbar-brand fw-bold" href="/">Shop</a>
            
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>
            
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav me-auto mb-2 mb-lg-0">
                    <li class="nav-item">
                        <span class="nav-link text-white-50">í¬íŠ¸í´ë¦¬ì˜¤ìš© ì‡¼í•‘ëª°</span>
                    </li>
                </ul>

                <ul class="navbar-nav ms-auto align-items-center gap-2">
                    <li class="nav-item d-none" id="nav-item-add">
                        <a class="nav-link btn btn-outline-warning text-warning btn-sm px-3" href="/item-add.html">
                            <i class="bi bi-plus-lg"></i> ìƒí’ˆ ë“±ë¡
                        </a>
                    </li>
                    <li class="nav-item d-none" id="nav-cart">
                        <a class="nav-link text-white" href="/cart.html">
                            <i class="bi bi-cart4 fs-5"></i> <span>ì¥ë°”êµ¬ë‹ˆ</span>
                        </a>
                    </li>
                    <li class="nav-item d-none" id="nav-admin">
					    <a class="nav-link text-danger fw-bold" href="/admin.html">
					        <i class="bi bi-gear-fill"></i> ê´€ë¦¬ì ì„¤ì •
					    </a>
					</li>
                    <li class="nav-item d-none" id="nav-mypage">
                        <a class="nav-link text-white" href="/mypage.html">
                            <i class="bi bi-person-circle"></i> ë§ˆì´í˜ì´ì§€
                        </a>
                    </li>
                    <li class="nav-item" id="nav-login">
                        <a class="nav-link" href="/login.html">ë¡œê·¸ì¸</a>
                    </li>
                    <li class="nav-item" id="nav-join">
                        <a class="nav-link btn btn-primary text-white btn-sm px-3" href="/join.html">íšŒì›ê°€ì…</a>
                    </li>
                    <li class="nav-item d-none" id="nav-welcome">
                        <span class="nav-link text-white small" id="welcome-message"></span>
                    </li>
                    <li class="nav-item d-none" id="nav-logout">
                        <a class="nav-link text-danger small" href="#" onclick="logout()">ë¡œê·¸ì•„ì›ƒ</a>
                    </li>
                </ul>
            </div>
        </div>
    </nav>

    <div class="hero-section text-center">
        <div class="container">
            <h1 class="display-5 fw-bold">Open Market</h1>
            <p class="lead">Spring Boot & Cloud Portfolio</p>
            
            <div class="row justify-content-center">
            <div class="col-md-6">
                <div class="input-group input-group-lg shadow-sm">
                    <input type="text" id="searchInput" class="form-control" placeholder="ìƒí’ˆì„ ê²€ìƒ‰í•´ë³´ì„¸ìš” (ì˜ˆ: í‹°ì…”ì¸ )" onkeyup="if(window.event.keyCode==13){searchItem()}">
                    <button class="btn btn-primary px-4" type="button" onclick="searchItem()">
                        <i class="bi bi-search"></i> ê²€ìƒ‰
                    </button>
                </div>
            </div>
        </div>
        </div>
            
        </div>
    </div>

    <div class="container mb-5">
        
        <div class="section-header">
            <h4 class="fw-bold">ğŸ”¥ ì‹ ìƒí’ˆ (ì „ì²´)</h4>
            <a href="/item-search.html" class="view-all-btn">ì „ì²´ë³´ê¸° <i class="bi bi-chevron-right"></i></a>
        </div>
        <div id="list-all" class="scrolling-wrapper">
            <div class="text-center w-100 py-4"><div class="spinner-border text-secondary"></div></div>
        </div>

        <div class="section-header">
            <h4 class="fw-bold">ğŸ‘— íŒ¨ì…˜/ì˜ë¥˜</h4>
            <a href="/item-search.html?categoryId=1&categoryName=íŒ¨ì…˜/ì˜ë¥˜" class="view-all-btn">ì „ì²´ë³´ê¸° <i class="bi bi-chevron-right"></i></a>
        </div>
        <div id="list-cat-1" class="scrolling-wrapper">
            <div class="text-center w-100 py-4"><div class="spinner-border text-secondary"></div></div>
        </div>

        <div class="section-header">
            <h4 class="fw-bold">ğŸ’» ê°€ì „/ë””ì§€í„¸</h4>
            <a href="/item-search.html?categoryId=2&categoryName=ê°€ì „/ë””ì§€í„¸" class="view-all-btn">ì „ì²´ë³´ê¸° <i class="bi bi-chevron-right"></i></a>
        </div>
        <div id="list-cat-2" class="scrolling-wrapper">
            <div class="text-center w-100 py-4"><div class="spinner-border text-secondary"></div></div>
        </div>

        <div class="section-header">
            <h4 class="fw-bold">ğŸ ì‹ ì„  ì‹í’ˆ</h4>
            <a href="/item-search.html?categoryId=3&categoryName=ì‹ ì„  ì‹í’ˆ" class="view-all-btn">ì „ì²´ë³´ê¸° <i class="bi bi-chevron-right"></i></a>
        </div>
        <div id="list-cat-3" class="scrolling-wrapper">
            <div class="text-center w-100 py-4"><div class="spinner-border text-secondary"></div></div>
        </div>

    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
    // ì´ˆê¸° ì‹¤í–‰
    document.addEventListener("DOMContentLoaded", () => {
    	// 1. URLì— ìˆëŠ” í† í° ì²˜ë¦¬ (êµ¬ê¸€ ë¡œê·¸ì¸ ì§í›„)
        const tokenFromUrl = handleGoogleLoginToken();

        // 2. ë¡œê·¸ì¸ ìƒíƒœ ì²´í¬ ë° UI ê°±ì‹  (ë¹„ë™ê¸° í•¨ìˆ˜ í˜¸ì¶œ)
        checkLoginStatus(tokenFromUrl);
        
        // ê° ì„¹ì…˜ë³„ ë°ì´í„° ë¡œë“œ (ë³‘ë ¬ ì²˜ë¦¬)
        loadItemsBySection(null, 'list-all');   // ì „ì²´ ìƒí’ˆ
        loadItemsBySection(1, 'list-cat-1');    // íŒ¨ì…˜
        loadItemsBySection(2, 'list-cat-2');    // ê°€ì „
        loadItemsBySection(3, 'list-cat-3');    // ì‹í’ˆ
    });
    
    // êµ¬ê¸€ ë¡œê·¸ì¸ í† í° ì²˜ë¦¬
   function handleGoogleLoginToken() {
        const urlParams = new URLSearchParams(window.location.search);
        const token = urlParams.get('token');

        // [ë””ë²„ê¹…] í˜„ì¬ URLì— í† í°ì´ ìˆëŠ”ì§€ ëˆˆìœ¼ë¡œ í™•ì¸
        console.log("í˜„ì¬ URL:", window.location.href);

        if (token) {
            alert("í† í° ë°œê²¬! ì €ì¥í•©ë‹ˆë‹¤: " + token.substring(0, 10) + "..."); // ì•Œë¦¼ì°½ ì¶”ê°€
            localStorage.setItem('accessToken', token);
            window.history.replaceState({}, document.title, "/");
            return token; 
        } else {
            console.log("URLì— í† í°ì´ ì—†ìŠµë‹ˆë‹¤."); // í† í° ì—†ìŒ ë¡œê·¸
        }
        return null;
    }

 // ë¡œê·¸ì¸ ìƒíƒœ ì²´í¬ + ë‚´ ì •ë³´ ê°€ì ¸ì˜¤ê¸° (ë¹„ë™ê¸°)
    async function checkLoginStatus(tokenFromUrl) {
        // ë°©ê¸ˆ URLì—ì„œ ë°›ì€ í† í°ì´ ìˆê±°ë‚˜, ì•„ë‹ˆë©´ ì €ì¥ì†Œì— ìˆëŠ” í† í° ì‚¬ìš©
        const token = tokenFromUrl || localStorage.getItem('accessToken');

        if (token) {
            // A. ì¼ë‹¨ UIë¥¼ ë¡œê·¸ì¸ ìƒíƒœë¡œ ë³€ê²½ (ë¹ ë¥¸ ë°˜ì‘ì„±ì„ ìœ„í•´)
            document.getElementById('nav-login').classList.add('d-none');
            document.getElementById('nav-join').classList.add('d-none');
            document.getElementById('nav-welcome').classList.remove('d-none');
            document.getElementById('nav-cart').classList.remove('d-none');
            document.getElementById('nav-mypage').classList.remove('d-none');
            document.getElementById('nav-logout').classList.remove('d-none');

            // B. ì„œë²„ì— "ë‚´ ì •ë³´(ì´ë¦„, ê¶Œí•œ)" ìš”ì²­
            try {
                const res = await fetch('/api/members/me', {
                    headers: {
                        'Authorization': 'Bearer ' + token
                    }
                });

                if (res.ok) {
                    const member = await res.json();
                    
                    // 1. ë°›ì•„ì˜¨ ìµœì‹  ì •ë³´ë¡œ localStorage ì—…ë°ì´íŠ¸
                    localStorage.setItem('userName', member.name);
                    localStorage.setItem('role', member.role);

                    // 2. í™˜ì˜ ë©”ì‹œì§€ ì—…ë°ì´íŠ¸
                    document.getElementById('welcome-message').innerText = `${member.name}ë‹˜ í™˜ì˜í•©ë‹ˆë‹¤!`;

                    // 3. íŒë§¤ì/ê´€ë¦¬ì ë©”ë‰´ í‘œì‹œ
                    //íŒë§¤ì ë©”ë‰´ í‘œì‹œ
	                if (member.role === 'SELLER' || member.role === 'ADMIN') {
	                    document.getElementById('nav-item-add').classList.remove('d-none');
	                }
	
	                //  ê´€ë¦¬ìì¼ ê²½ìš° ê´€ë¦¬ì ë²„íŠ¼ í‘œì‹œ 
	                if (member.role === 'ADMIN') {
	                    const adminBtn = document.getElementById('nav-admin');
	                    if(adminBtn) adminBtn.classList.remove('d-none');
	                }
                } else {
                    // í† í°ì´ ë§Œë£Œë˜ì—ˆê±°ë‚˜ ìœ„ì¡°ëœ ê²½ìš° -> ë¡œê·¸ì•„ì›ƒ ì²˜ë¦¬
                    console.log("ìœ íš¨í•˜ì§€ ì•Šì€ í† í°ì…ë‹ˆë‹¤.");
                    logout(false); // false: confirm ì—†ì´ ì¡°ìš©íˆ ë¡œê·¸ì•„ì›ƒ
                }
            } catch (e) {
                console.error("ë‚´ ì •ë³´ ì¡°íšŒ ì¤‘ ì˜¤ë¥˜:", e);
            }
        }
    }
    
 // ì„¹ì…˜ë³„ ìƒí’ˆ ë¡œë“œ í•¨ìˆ˜ (ì¬ì‚¬ìš© ê°€ëŠ¥)
    function loadItemsBySection(categoryId, elementId) {
        // 1. URL ìƒì„±
        // page=0: ì²« í˜ì´ì§€
        // size=10: 10ê°œë§Œ ê°€ì ¸ì˜´
        // sort=id,desc: ID ê¸°ì¤€ ë‚´ë¦¼ì°¨ìˆœ (ìµœì‹  ë“±ë¡ëœ ìƒí’ˆì´ IDê°€ ë†’ìœ¼ë¯€ë¡œ ìµœì‹ ìˆœì´ ë¨)
        let url = `/api/items?page=0&size=10&sort=id,desc`; 
        
        if (categoryId) {
            url += `&categoryId=${categoryId}`;
        }

        const container = document.getElementById(elementId);
        // í˜¹ì‹œ HTMLì— IDê°€ ì—†ìœ¼ë©´ ì—ëŸ¬ ë‚˜ì§€ ì•Šê²Œ ë°©ì–´ ì½”ë“œ
        if (!container) {
            console.error(`IDê°€ ${elementId}ì¸ HTML ìš”ì†Œë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.`);
            return;
        }

        fetch(url)
            .then(res => {
                if(!res.ok) throw new Error('Load Failed');
                return res.json();
            })
            .then(data => {
                container.innerHTML = ""; // ë¡œë”© ìŠ¤í”¼ë„ˆ ì œê±°

                // Page ê°ì²´ë¡œ ì˜¤ëŠ”ì§€ Listë¡œ ì˜¤ëŠ”ì§€ì— ë”°ë¼ ì²˜ë¦¬ (ë³´í†µ contentì— ë‹´ê²¨ì˜´)
                const items = data.content ? data.content : data;

                // [ë¹ˆ ìƒí’ˆ ì²˜ë¦¬] ë“±ë¡ëœ ê²Œ ì—†ìœ¼ë©´ ë©”ì‹œì§€ ë„ìš°ê¸°
                if (items.length === 0) {
                    container.innerHTML = `
                        <div class="text-muted py-5 w-100 text-center small">
                            <i class="bi bi-exclamation-circle d-block mb-2 fs-4"></i>
                            ì•„ì§ ë“±ë¡ëœ ìƒí’ˆì´ ì—†ìŠµë‹ˆë‹¤.
                        </div>`;
                    return;
                }

                items.forEach(item => {
                    const imgUrl = item.imageUrl ? `/images/${item.imageUrl}` : 'https://dummyimage.com/600x400/dee2e6/6c757d.jpg';
                    const detailUrl = `/item-detail.html?id=${item.id}`; 
                    const price = item.price ? item.price.toLocaleString() : 0; // ê°€ê²© í¬ë§·íŒ… ì•ˆì „ì¥ì¹˜

                    const html = `
                        <div class="card card-block border-0 shadow-sm product-card" onclick="location.href='${detailUrl}'" style="cursor: pointer;">
                            <img src="${imgUrl}" class="card-img-top rounded" alt="${item.name}" onerror="this.src='https://dummyimage.com/600x400/dee2e6/6c757d.jpg?text=No+Image'">
                            <div class="card-body p-3">
                                <h6 class="card-title fw-bold text-truncate">${item.name}</h6>
                                <p class="card-text text-danger fw-bold mb-1">${price}ì›</p>
                            </div>
                        </div>
                    `;
                    container.insertAdjacentHTML('beforeend', html);
                });
            })
            .catch(err => {
                console.error(err);
                container.innerHTML = '<div class="text-danger p-3 text-center">ìƒí’ˆ ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¤ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.</div>';
            });
    }

 // [ê¸°ëŠ¥] ë¡œê·¸ì•„ì›ƒ ( íŒŒë¼ë¯¸í„°ë¡œ í™•ì¸ì°½ ì—¬ë¶€ ì œì–´)
    function logout(ask = true) {
        if(ask && !confirm("ë¡œê·¸ì•„ì›ƒ í•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) return;
        
        localStorage.clear();
        window.location.href = '/';
    }
    
 // [ê¸°ëŠ¥] ê²€ìƒ‰ ì´ë™ í•¨ìˆ˜
    function searchItem() {
        const keyword = document.getElementById('searchInput').value;
        if (!keyword.trim()) {
            alert("ê²€ìƒ‰ì–´ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”!");
            return;
        }
        // ê²€ìƒ‰ í˜ì´ì§€ë¡œ í‚¤ì›Œë“œë¥¼ ë“¤ê³  ì´ë™
        location.href = `/item-search.html?keyword=${encodeURIComponent(keyword)}`;
    }
    </script>
</body>
</html>