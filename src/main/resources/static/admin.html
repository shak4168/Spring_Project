<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>Cloud Native Shop - í†µí•© ê´€ë¦¬ì</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css" rel="stylesheet">
    <style>
        .cursor-pointer { cursor: pointer; }
        .table-hover tbody tr:hover { background-color: #f8f9fa; }
        .nav-link { cursor: pointer; }
        .badge { font-weight: 500; letter-spacing: 0.5px; }
    </style>
</head>
<body class="bg-light">

<nav class="navbar navbar-expand-lg navbar-dark bg-dark sticky-top">
    <div class="container-fluid">
        <a class="navbar-brand fw-bold" href="/">
            <i class="bi bi-cloud-check me-2"></i>Cloud Shop Admin
        </a>
        <div>
            <a href="/" class="btn btn-outline-light btn-sm me-2">ğŸ  ì‡¼í•‘ëª° ë©”ì¸</a>
            <button class="btn btn-secondary btn-sm" onclick="logout()">ë¡œê·¸ì•„ì›ƒ</button>
        </div>
    </div>
</nav>

<div class="container-fluid mt-4">
    <div class="row">
        <div class="col-md-2">
            <div class="list-group shadow-sm">
                <a class="list-group-item list-group-item-action active" id="menu-seller" onclick="switchTab('seller')">
                    ğŸ“¢ íŒë§¤ì ì‹ ì²­ ê´€ë¦¬
                </a>
                <a class="list-group-item list-group-item-action" id="menu-member" onclick="switchTab('member')">
                    ğŸ‘¥ íšŒì› ê´€ë¦¬
                </a>
               <a class="list-group-item list-group-item-action cursor-pointer" id="menu-item" onclick="switchTab('item')">
                    ğŸ“¦ ìƒí’ˆ ê´€ë¦¬
                </a>
            </div>
        </div>

        <div class="col-md-10">
            
            <div id="section-seller">
                <h3 class="mb-4 border-bottom pb-2">ğŸ“¢ íŒë§¤ì ê¶Œí•œ ì‹ ì²­ ëª©ë¡</h3>
                <div class="card shadow-sm border-0">
                    <div class="card-body">
                        <table class="table align-middle">
                            <thead class="table-light">
                                <tr>
                                    <th>ID</th>
                                    <th>ì‹ ì²­ì(Email)</th>
                                    <th>ì‹ ì²­ ì¼ì‹œ</th>
                                    <th>ìƒíƒœ</th>
                                    <th>ê´€ë¦¬</th>
                                </tr>
                            </thead>
                            <tbody id="sellerTableBody">
                                <tr><td colspan="5" class="text-center text-muted py-5">ë¡œë”©ì¤‘...</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <div id="section-member" class="d-none">
                <h3 class="mb-4 border-bottom pb-2">ğŸ‘¥ íšŒì› ê´€ë¦¬</h3>
                
                <div class="row mb-3">
                    <div class="col-md-6">
                        <div class="input-group">
                            <span class="input-group-text bg-white"><i class="bi bi-search"></i></span>
                            <input type="text" id="memberSearchInput" class="form-control" placeholder="ì´ë¦„ ë˜ëŠ” ì´ë©”ì¼ ê²€ìƒ‰" onkeyup="if(window.event.keyCode==13){loadMembers(0)}">
                            <button class="btn btn-primary" onclick="loadMembers(0)">ê²€ìƒ‰</button>
                        </div>
                    </div>
                </div>

                <div class="card shadow-sm border-0">
                    <div class="card-body">
                        <table class="table table-hover align-middle">
                            <thead class="table-light">
                                <tr>
                                    <th>ID</th>
                                    <th>ì´ë©”ì¼</th>
                                    <th>ì´ë¦„</th>
                                    <th>ê¶Œí•œ</th>
                                    <th>ìƒíƒœ</th>
                                    <th>ê°€ì…ì¼</th>
                                    <th>ìƒì„¸</th>
                                </tr>
                            </thead>
                            <tbody id="memberTableBody">
                                <tr><td colspan="7" class="text-center text-muted py-5">ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</td></tr>
                            </tbody>
                        </table>
                        
                        <div id="pagination-wrapper" class="d-flex justify-content-center mt-4 d-none">
                            <button id="btn-prev" class="btn btn-sm btn-outline-secondary me-2" onclick="prevPage()">ì´ì „</button>
                            <span class="align-self-center px-2 fw-bold text-primary" id="page-indicator">1</span>
                            <button id="btn-next" class="btn btn-sm btn-outline-secondary ms-2" onclick="nextPage()">ë‹¤ìŒ</button>
                        </div>
                    </div>
                </div>
            </div>
            
            <div id="section-item" class="d-none">
                <h3 class="mb-4 border-bottom pb-2">ğŸ“¦ ì „ì²´ ìƒí’ˆ ê´€ë¦¬</h3>
                
                <div class="row mb-3">
                    <div class="col-md-6">
                        <div class="input-group">
                            <span class="input-group-text bg-white"><i class="bi bi-search"></i></span>
                            <input type="text" id="itemSearchInput" class="form-control" placeholder="ìƒí’ˆëª… ê²€ìƒ‰" onkeyup="if(window.event.keyCode==13){loadItems(0)}">
                            <button class="btn btn-primary" onclick="loadItems(0)">ê²€ìƒ‰</button>
                        </div>
                    </div>
                </div>
                
                <div class="card shadow-sm border-0">
                    <div class="card-body">
                        <table class="table align-middle table-hover">
                            <thead class="table-light">
                                <tr>
                                    <th>ID</th>
                                    <th>ìƒí’ˆëª…</th>
                                    <th>ê°€ê²©</th>
                                    <th>ì¬ê³ </th>
                                    <th>íŒë§¤ì</th>
                                    <th>ìƒíƒœ</th>
                                    <th>ê´€ë¦¬</th>
                                </tr>
                            </thead>
                            <tbody id="itemTableBody">
                                <tr><td colspan="7" class="text-center py-5">ë¡œë”©ì¤‘...</td></tr>
                            </tbody>
                        </table>
                        
                        <div id="item-pagination-wrapper" class="d-flex justify-content-center mt-4 d-none">
                            <button id="btn-item-prev" class="btn btn-sm btn-outline-secondary me-2" onclick="prevItemPage()">ì´ì „</button>
                            <span class="align-self-center px-2 fw-bold text-primary" id="item-page-indicator">1</span>
                            <button id="btn-item-next" class="btn btn-sm btn-outline-secondary ms-2" onclick="nextItemPage()">ë‹¤ìŒ</button>
                        </div>
                    </div>
                </div>
            </div>
            
        </div>
    </div>
</div>

<div class="modal fade" id="memberDetailModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header bg-light">
                <h5 class="modal-title fw-bold">íšŒì› ìƒì„¸ ì •ë³´</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="row mb-4">
                    <div class="col-md-6 border-end">
                        <h6 class="text-primary fw-bold mb-3"><i class="bi bi-person-lines-fill"></i> ê¸°ë³¸ ì •ë³´</h6>
                        <table class="table table-sm table-borderless">
                            <tr><th class="text-muted w-25">ì´ë¦„</th><td id="modal-name" class="fw-bold"></td></tr>
                            <tr><th class="text-muted">ì´ë©”ì¼</th><td id="modal-email"></td></tr>
                            <tr><th class="text-muted">ì „í™”ë²ˆí˜¸</th><td id="modal-phone"></td></tr>
                        </table>
                    </div>
                    <div class="col-md-6 ps-4">
                        <h6 class="text-primary fw-bold mb-3"><i class="bi bi-shield-lock"></i> ê³„ì • ìƒíƒœ</h6>
                        <table class="table table-sm table-borderless">
                           <tr>
                                <th class="text-muted w-25">ê¶Œí•œ</th>
                                <td>
                                    <select id="modal-role" class="form-select form-select-sm">
                                        <option value="USER">USER (ì¼ë°˜)</option>
                                        <option value="SELLER">SELLER (íŒë§¤ì)</option>
                                        <option value="ADMIN">ADMIN (ê´€ë¦¬ì)</option>
                                        <option value="BAN" class="text-danger fw-bold">BAN (í™œë™ ì •ì§€)</option>
                                    </select>
                                </td>
                            </tr>
                            <tr>
                                <th class="text-muted">ìƒíƒœ</th>
                                <td>
                                    <select id="modal-delYn" class="form-select form-select-sm">
                                        <option value="N">ì •ìƒ (í™œë™ì¤‘)</option>
                                        <option value="Y">ì •ì§€/íƒˆí‡´</option>
                                    </select>
                                </td>
                            </tr>
                            <tr><th class="text-muted">ì£¼ì†Œ</th><td id="modal-address"></td></tr>
                        </table>
                    </div>
                </div>
                
                <hr>

                <h6 class="text-success fw-bold mb-3">ğŸ›ï¸ ìµœê·¼ ì£¼ë¬¸ ë‚´ì—­</h6>
                <div class="table-responsive" style="max-height: 300px; overflow-y: auto;">
                    <table class="table table-bordered table-sm table-hover text-center">
                        <thead class="table-light sticky-top">
                            <tr>
                                <th>ì£¼ë¬¸ì¼</th>
                                <th>ìƒíƒœ</th>
                                <th>ëŒ€í‘œ ìƒí’ˆëª…</th>
                                <th>ì´ ê²°ì œê¸ˆì•¡</th>
                            </tr>
                        </thead>
                        <tbody id="modal-order-list">
                            </tbody>
                    </table>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">ë‹«ê¸°</button>
                <button type="button" class="btn btn-primary" onclick="saveMemberChanges()">ìˆ˜ì • ì €ì¥</button>
            </div>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script>
    // ==========================================
    // 1. ì „ì—­ ë³€ìˆ˜ (ìƒíƒœ ê´€ë¦¬ìš©)
    // ==========================================
    let currentMemberPage = 0;
    let isLastMemberPage = false; 

    let currentItemPage = 0;
    let isLastItemPage = false;   

    let currentMemberId = null; // ëª¨ë‹¬ì—ì„œ ìˆ˜ì •í•  íšŒì› ID

    // ==========================================
    // 2. ì´ˆê¸° ì‹¤í–‰ ë° íƒ­ ì „í™˜
    // ==========================================
    document.addEventListener('DOMContentLoaded', () => {
        if(checkAdminRole()) {
            loadSellerRequests(); // ì´ˆê¸° ë¡œë”© ì‹œ ê¸°ë³¸ íƒ­ í™œì„±í™”
        }
    });

    function switchTab(tabName) {
        // ë©”ë‰´ ìŠ¤íƒ€ì¼ í™œì„±í™”
        document.querySelectorAll('.list-group-item').forEach(el => el.classList.remove('active'));
        document.getElementById('menu-' + tabName).classList.add('active');

        // ì„¹ì…˜ ë³´ì´ê¸°/ìˆ¨ê¸°ê¸°
        ['seller', 'member', 'item'].forEach(section => {
            document.getElementById('section-' + section).classList.add('d-none');
        });
        document.getElementById('section-' + tabName).classList.remove('d-none');
        
        // [UX ê°œì„ ] íƒ­ ì „í™˜ ì‹œ ê²€ìƒ‰ì°½ ì´ˆê¸°í™”
        document.getElementById('memberSearchInput').value = '';
        document.getElementById('itemSearchInput').value = '';

        // íƒ­ë³„ ë°ì´í„° ìƒˆë¡œê³ ì¹¨ (ì²« í˜ì´ì§€ë¶€í„°)
        if (tabName === 'seller') loadSellerRequests();
        if (tabName === 'member') loadMembers(0);
        if (tabName === 'item') loadItems(0);
    }

    // ==========================================
    // [ê¸°ëŠ¥ 1] íŒë§¤ì ì‹ ì²­ ê´€ë¦¬
    // ==========================================
    async function loadSellerRequests() {
        const token = localStorage.getItem('accessToken');
        try {
            const res = await fetch('/api/admin/seller-requests', {
                headers: { 'Authorization': 'Bearer ' + token }
            });
            const data = await res.json();
            
            const tbody = document.getElementById('sellerTableBody');
            tbody.innerHTML = '';

            if (data.length === 0) {
                tbody.innerHTML = '<tr><td colspan="5" class="text-center py-5 text-muted">ëŒ€ê¸° ì¤‘ì¸ ì‹ ì²­ì´ ì—†ìŠµë‹ˆë‹¤.</td></tr>';
                return;
            }

            data.forEach(req => {
                const html = `
                    <tr>
                        <td>${req.id}</td>
                        <td>${req.email} <br><small class="text-muted">${req.username}</small></td>
                        <td>${new Date(req.requestedAt).toLocaleString()}</td>
                        <td><span class="badge bg-warning text-dark">${req.status}</span></td>
                        <td>
                            <button class="btn btn-sm btn-success" onclick="approveRequest(${req.id})">ìŠ¹ì¸</button>
                            <button class="btn btn-sm btn-outline-danger" onclick="rejectRequest(${req.id})">ë°˜ë ¤</button>
                        </td>
                    </tr>`;
                tbody.insertAdjacentHTML('beforeend', html);
            });
        } catch(e) { console.error(e); }
    }

    async function approveRequest(id) {
        if(!confirm('ìŠ¹ì¸í•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;
        callApi(`/api/admin/seller-requests/${id}/approve`, 'POST', 'ìŠ¹ì¸ë˜ì—ˆìŠµë‹ˆë‹¤.', loadSellerRequests);
    }
    
    async function rejectRequest(id) {
        if(!confirm('ë°˜ë ¤í•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;
        callApi(`/api/admin/seller-requests/${id}/reject`, 'POST', 'ë°˜ë ¤ë˜ì—ˆìŠµë‹ˆë‹¤.', loadSellerRequests);
    }

    // ==========================================
    // [ê¸°ëŠ¥ 2] íšŒì› ê´€ë¦¬ (ê²€ìƒ‰ + í˜ì´ì§• + ëª¨ë‹¬)
    // ==========================================
    async function loadMembers(page) {
        const token = localStorage.getItem('accessToken');
        const keyword = document.getElementById('memberSearchInput').value;
        
        let url = `/api/admin/members?page=${page}&size=10`;
        if(keyword) url += `&keyword=${encodeURIComponent(keyword)}`;

        try {
            const res = await fetch(url, { headers: { 'Authorization': 'Bearer ' + token } });
            
            // [ë°©ì–´ ì½”ë“œ] ì„œë²„ ì—ëŸ¬ ì²´í¬
            if (!res.ok) {
                console.error("ì„œë²„ ì‘ë‹µ ì˜¤ë¥˜:", res.status);
                return; 
            }
            
            const data = await res.json();
            
            // 1. í…Œì´ë¸” ë Œë”ë§
            renderMemberTable(data.content || []);
            
            // 2. í˜ì´ì§€ë„¤ì´ì…˜ UI ì—…ë°ì´íŠ¸
            const wrapper = document.getElementById('pagination-wrapper');
            
            // í˜ì´ì§€ê°€ 1ê°œ ì´í•˜ê±°ë‚˜ ë°ì´í„°ê°€ ì—†ìœ¼ë©´ ë²„íŠ¼ ìˆ¨ê¹€
            if (!data.totalPages || data.totalPages <= 1) {
                wrapper.classList.add('d-none');
            } else {
                wrapper.classList.remove('d-none');
                
                // ìƒíƒœ ë³€ìˆ˜ ì—…ë°ì´íŠ¸
                currentMemberPage = (typeof data.number !== 'undefined') ? data.number : 0;
                isLastMemberPage = data.last; 

                // UI ì—…ë°ì´íŠ¸
                document.getElementById('page-indicator').innerText = currentMemberPage + 1;
                document.getElementById('btn-prev').disabled = data.first; 
                document.getElementById('btn-next').disabled = data.last;
            }
        } catch(e) { console.error(e); }
    }

    function renderMemberTable(members) {
        const tbody = document.getElementById('memberTableBody');
        tbody.innerHTML = '';
        
        if(!members || members.length === 0) {
            tbody.innerHTML = '<tr><td colspan="7" class="text-center py-5 text-muted">ê²€ìƒ‰ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤.</td></tr>';
            return;
        }

        members.forEach(m => {
            let roleBadge = 'bg-secondary';
            if(m.role === 'ADMIN') roleBadge = 'bg-danger';
            if(m.role === 'SELLER') roleBadge = 'bg-success';
            if(m.role === 'USER') roleBadge = 'bg-primary';

            const html = `
                <tr class="cursor-pointer" onclick="openMemberDetail(${m.id})" title="ìƒì„¸ ì •ë³´ ë³´ê¸°">
                    <td>${m.id}</td>
                    <td>${m.email}</td>
                    <td class="fw-bold">${m.name}</td>
                    <td><span class="badge ${roleBadge}">${m.role}</span></td>
                    <td>${m.delYn === 'Y' ? '<span class="badge bg-danger">íƒˆí‡´</span>' : '<span class="badge bg-light text-success border">ì •ìƒ</span>'}</td>
                    <td>${m.createdAt}</td>
                    <td><button class="btn btn-sm btn-outline-dark">ì¡°íšŒ</button></td>
                </tr>`;
            tbody.insertAdjacentHTML('beforeend', html);
        });
    }

    function prevPage() { if(currentMemberPage > 0) loadMembers(currentMemberPage - 1); }
    function nextPage() { if(!isLastMemberPage) loadMembers(currentMemberPage + 1); }


    // ==========================================
    // [ê¸°ëŠ¥ 3] ìƒí’ˆ ê´€ë¦¬ (ê²€ìƒ‰ + í˜ì´ì§• + ì‚­ì œ)
    // ==========================================
    async function loadItems(page) {
        const token = localStorage.getItem('accessToken');
        const keyword = document.getElementById('itemSearchInput').value; 
        
        let url = `/api/admin/items?page=${page}&size=10`;
        if(keyword) {
            url += `&keyword=${encodeURIComponent(keyword)}`;
        }

        try {
            const res = await fetch(url, {
                headers: { 'Authorization': 'Bearer ' + token }
            });

            // [ë°©ì–´ ì½”ë“œ] ì„œë²„ ì—ëŸ¬(500) ë°œìƒ ì‹œ ì¤‘ë‹¨
            if (!res.ok) {
                console.error("ì„œë²„ ì—ëŸ¬ ë°œìƒ:", res.status);
                return;
            }

            const data = await res.json();
            
            const tbody = document.getElementById('itemTableBody');
            tbody.innerHTML = '';

            // ë°ì´í„°ê°€ ì—†ê±°ë‚˜ contentê°€ nullì¸ ê²½ìš° ë°©ì–´
            const content = data.content || [];

            if (content.length === 0) {
                tbody.innerHTML = '<tr><td colspan="7" class="text-center py-5 text-muted">ê²€ìƒ‰ëœ ìƒí’ˆì´ ì—†ìŠµë‹ˆë‹¤.</td></tr>';
                document.getElementById('item-pagination-wrapper').classList.add('d-none');
                return;
            }

            // í…Œì´ë¸” ê·¸ë¦¬ê¸°
            content.forEach(item => {
                const statusBadge = item.sellStatus === 'SELL' ? 'bg-success' : 'bg-secondary';
                const statusText = item.sellStatus === 'SELL' ? 'íŒë§¤ì¤‘' : 'í’ˆì ˆ';
                
                const html = `
                    <tr>
                        <td>${item.id}</td>
                        <td class="fw-bold text-start ps-4">${item.itemName}</td>
                        <td>${item.price.toLocaleString()}ì›</td>
                        <td>${item.stockNumber}ê°œ</td>
                        <td><small>${item.sellerEmail}</small></td>
                        <td><span class="badge ${statusBadge}">${statusText}</span></td>
                        <td>
                            <button class="btn btn-sm btn-outline-danger" onclick="deleteItem(${item.id})">ì‚­ì œ</button>
                        </td>
                    </tr>`;
                tbody.insertAdjacentHTML('beforeend', html);
            });
            
            // í˜ì´ì§€ë„¤ì´ì…˜ ì²˜ë¦¬
            const wrapper = document.getElementById('item-pagination-wrapper');
            
            // í˜ì´ì§€ê°€ 1ê°œ ì´í•˜ê±°ë‚˜ ì—†ìœ¼ë©´ ìˆ¨ê¹€
            if (!data.totalPages || data.totalPages <= 1) {
                wrapper.classList.add('d-none');
            } else {
                wrapper.classList.remove('d-none');
                
                // [ì•ˆì „ì¥ì¹˜] NaN ë°©ì§€ (ê°’ì´ ì—†ìœ¼ë©´ 0ìœ¼ë¡œ)
                currentItemPage = (typeof data.number !== 'undefined') ? data.number : 0;
                isLastItemPage = data.last; 

                document.getElementById('item-page-indicator').innerText = currentItemPage + 1;
                document.getElementById('btn-item-prev').disabled = data.first;
                document.getElementById('btn-item-next').disabled = data.last;
            }

        } catch(e) { console.error(e); }
    }

    function prevItemPage() { if(currentItemPage > 0) loadItems(currentItemPage - 1); }
    function nextItemPage() { if(!isLastItemPage) loadItems(currentItemPage + 1); }

    async function deleteItem(id) {
        if(!confirm("âš ï¸ ê²½ê³ : ì •ë§ ì´ ìƒí’ˆì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?\nì‚­ì œëœ ìƒí’ˆì€ ë³µêµ¬í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.")) return;
        callApi(`/api/admin/items/${id}`, 'DELETE', 'ìƒí’ˆì´ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.', () => loadItems(currentItemPage));
    }

    // ==========================================
    // [ê³µí†µ] íšŒì› ìƒì„¸ ëª¨ë‹¬ ë¡œì§
    // ==========================================
    async function openMemberDetail(memberId) {
        currentMemberId = memberId;
        const token = localStorage.getItem('accessToken');
        
        try {
            const res = await fetch(`/api/admin/members/${memberId}`, {
                headers: { 'Authorization': 'Bearer ' + token }
            });
            
            if(!res.ok) throw new Error("ì •ë³´ ì¡°íšŒ ì‹¤íŒ¨");
            const detail = await res.json();
            
            document.getElementById('modal-name').innerText = detail.name;
            document.getElementById('modal-email').innerText = detail.email;
            document.getElementById('modal-phone').innerText = detail.phone || '-';
            document.getElementById('modal-address').innerText = detail.address || '-';
            
            let roleVal = detail.role;
            if (roleVal && roleVal.startsWith("ROLE_")) {
                roleVal = roleVal.replace("ROLE_", "");
            }
            document.getElementById('modal-role').value = roleVal;
            document.getElementById('modal-delYn').value = detail.delYn || "N";

            const orderBody = document.getElementById('modal-order-list');
            orderBody.innerHTML = '';
            
            if (!detail.orders || detail.orders.length === 0) {
                orderBody.innerHTML = '<tr><td colspan="4" class="text-center py-3 text-muted">ì£¼ë¬¸ ë‚´ì—­ì´ ì—†ìŠµë‹ˆë‹¤.</td></tr>';
            } else {
                detail.orders.forEach(o => {
                    let itemName = o.orderItems[0].itemName;
                    if(o.orderItems.length > 1) itemName += ` ì™¸ ${o.orderItems.length - 1}ê±´`;

                    const html = `
                        <tr>
                            <td>${o.orderDate}</td>
                            <td><span class="badge bg-light text-dark border">${o.orderStatus}</span></td>
                            <td class="text-start ps-3">${itemName}</td>
                            <td class="fw-bold text-end pe-3">${o.totalPrice.toLocaleString()}ì›</td>
                        </tr>`;
                    orderBody.insertAdjacentHTML('beforeend', html);
                });
            }

            const modalEl = document.getElementById('memberDetailModal');
            let modal = bootstrap.Modal.getInstance(modalEl);
            if (!modal) {
                modal = new bootstrap.Modal(modalEl);
            }
            modal.show();

        } catch(e) {
            console.error(e);
            alert("íšŒì› ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¤ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.");
        }
    }

    async function saveMemberChanges() {
        if(!currentMemberId) return;
        if(!confirm("íšŒì› ì •ë³´ë¥¼ ìˆ˜ì •í•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) return;

        const token = localStorage.getItem('accessToken');
        const data = {
            role: document.getElementById('modal-role').value,
            delYn: document.getElementById('modal-delYn').value
        };

        try {
            const res = await fetch(`/api/admin/members/${currentMemberId}`, {
                method: 'PUT',
                headers: {
                    'Authorization': 'Bearer ' + token,
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(data)
            });

            if (res.ok) {
                alert("ìˆ˜ì •ë˜ì—ˆìŠµë‹ˆë‹¤.");
                const modalEl = document.getElementById('memberDetailModal');
                const modal = bootstrap.Modal.getInstance(modalEl);
                modal.hide();
                loadMembers(currentMemberPage); 
            } else {
                alert("ìˆ˜ì • ì‹¤íŒ¨");
            }
        } catch (e) {
            console.error(e);
            alert("ì„œë²„ ì˜¤ë¥˜ ë°œìƒ");
        }
    }

    // ==========================================
    // [ê³µí†µ] API í˜¸ì¶œ ìœ í‹¸ë¦¬í‹° & ë³´ì•ˆ
    // ==========================================
    async function callApi(url, method, successMsg, callback) {
        const token = localStorage.getItem('accessToken');
        try {
            const res = await fetch(url, {
                method: method,
                headers: { 'Authorization': 'Bearer ' + token }
            });
            if(res.ok) {
                alert(successMsg);
                if(callback) callback();
            } else {
                alert("ì²˜ë¦¬ ì‹¤íŒ¨");
            }
        } catch(e) { console.error(e); }
    }

    function checkAdminRole() {
        const token = localStorage.getItem('accessToken');
        if(!token) {
            alert('ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.');
            location.href = '/login.html';
            return false;
        }
        const role = localStorage.getItem('role'); 
        if(role !== 'ADMIN') {
            alert('ê´€ë¦¬ì ê¶Œí•œì´ ì—†ìŠµë‹ˆë‹¤.');
            location.href = '/';
            return false;
        }
        return true;
    }

    function logout() {
        if(!confirm("ë¡œê·¸ì•„ì›ƒ í•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) return;
        localStorage.clear();
        location.href = '/';
    }
</script>
</body>
</html>