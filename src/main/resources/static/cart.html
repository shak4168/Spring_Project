<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>ì¥ë°”êµ¬ë‹ˆ - Shop</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        .cart-img {
            width: 80px;
            height: 80px;
            object-fit: cover;
            border-radius: 8px;
        }
    </style>
</head>
<body class="bg-light">

    <nav class="navbar navbar-expand-lg navbar-dark bg-dark mb-5">
        <div class="container">
            <a class="navbar-brand fw-bold" href="/">Shop</a>
        </div>
    </nav>

    <div class="container">
        <h2 class="mb-4 fw-bold">ğŸ›’ ë‚˜ì˜ ì¥ë°”êµ¬ë‹ˆ</h2>

        <div class="row">
            <div class="col-md-8">
                <div class="card shadow-sm border-0 mb-4">
                    <div class="card-body p-0">
                        <table class="table table-hover mb-0 align-middle">
                            <thead class="table-light">
                                <tr>
                                    <th scope="col" class="py-3 ps-4">ìƒí’ˆ ì •ë³´</th>
                                    <th scope="col" class="py-3">ìˆ˜ëŸ‰</th>
                                    <th scope="col" class="py-3">ê°€ê²©</th>
                                    <th scope="col" class="py-3 text-end pe-4">ê´€ë¦¬</th>
                                </tr>
                            </thead>
                            <tbody id="cart-list">
                                </tbody>
                        </table>
                        <div id="empty-message" class="text-center py-5 d-none">
                            <p class="text-muted mb-3">ì¥ë°”êµ¬ë‹ˆì— ë‹´ê¸´ ìƒí’ˆì´ ì—†ìŠµë‹ˆë‹¤.</p>
                            <a href="/" class="btn btn-primary">ì‡¼í•‘í•˜ëŸ¬ ê°€ê¸°</a>
                        </div>
                    </div>
                </div>
            </div>

            <div class="col-md-4">
                <div class="card shadow-sm border-0">
                    <div class="card-header bg-white py-3">
                        <h5 class="mb-0 fw-bold">ê²°ì œ ì˜ˆì • ê¸ˆì•¡</h5>
                    </div>
                    <div class="card-body">
                        <div class="d-flex justify-content-between mb-3">
                            <span class="text-muted">ì´ ìƒí’ˆê¸ˆì•¡</span>
                            <strong id="total-price-display">0ì›</strong>
                        </div>
                        <div class="d-flex justify-content-between mb-4">
                            <span class="text-muted">ë°°ì†¡ë¹„</span>
                            <strong>ë¬´ë£Œ</strong>
                        </div>
                        <hr>
                        <div class="d-flex justify-content-between mb-4">
                            <span class="fs-5 fw-bold">ìµœì¢… ê²°ì œ ê¸ˆì•¡</span>
                            <span class="fs-5 fw-bold text-danger" id="final-price-display">0ì›</span>
                        </div>
                        
                        <button class="btn btn-dark w-100 btn-lg" onclick="orderAll()">
                            ì „ì²´ ì£¼ë¬¸í•˜ê¸°
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

    <script>
        // í˜ì´ì§€ ë¡œë“œ ì‹œ ì¥ë°”êµ¬ë‹ˆ ëª©ë¡ ë¶ˆëŸ¬ì˜¤ê¸°
        document.addEventListener("DOMContentLoaded", () => {
            loadCart();
        });

        // 1. ì¥ë°”êµ¬ë‹ˆ ëª©ë¡ ì¡°íšŒ í•¨ìˆ˜
        function loadCart() {
            const token = localStorage.getItem('accessToken');
            
            // ë¡œê·¸ì¸ ì•ˆ í–ˆìœ¼ë©´ ë¡œê·¸ì¸ í˜ì´ì§€ë¡œ
            if (!token) {
                alert("ë¡œê·¸ì¸ì´ í•„ìš”í•œ ì„œë¹„ìŠ¤ì…ë‹ˆë‹¤.");
                window.location.href = '/login.html';
                return;
            }

            fetch('/api/cart', {
                method: 'GET',
                headers: {
                    'Authorization': 'Bearer ' + token
                }
            })
            .then(res => {
                if (res.status === 401) {
                    alert("ì„¸ì…˜ì´ ë§Œë£Œë˜ì—ˆìŠµë‹ˆë‹¤. ë‹¤ì‹œ ë¡œê·¸ì¸í•´ì£¼ì„¸ìš”.");
                    window.location.href = '/login.html';
                    return;
                }
                return res.json();
            })
            .then(list => {
                const listBody = document.getElementById('cart-list');
                const emptyMsg = document.getElementById('empty-message');
                let totalPrice = 0;

                listBody.innerHTML = ''; // ëª©ë¡ ì´ˆê¸°í™”

                if (list.length === 0) {
                    emptyMsg.classList.remove('d-none'); // ë¹„ì—ˆë‹¤ëŠ” ë©”ì‹œì§€ í‘œì‹œ
                } else {
                    emptyMsg.classList.add('d-none'); // ë©”ì‹œì§€ ìˆ¨ê¹€
                    
                    list.forEach(item => {
                        const img = item.imageUrl ? `/images/${item.imageUrl}` : 'https://dummyimage.com/100x100/dee2e6/6c757d.jpg';
                        const itemTotal = item.price * item.count;
                        totalPrice += itemTotal;

                        // í…Œì´ë¸” í–‰(Row) ìƒì„±
                        const row = `
                            <tr>
                                <td class="ps-4">
                                    <div class="d-flex align-items-center">
                                        <img src="${img}" alt="${item.itemName}" class="cart-img me-3">
                                        <div>
                                            <a href="/item-detail.html?id=${item.itemId}" class="text-decoration-none text-dark fw-bold">${item.itemName}</a>
                                            <div class="text-muted small">${item.price.toLocaleString()}ì›</div>
                                        </div>
                                    </div>
                                </td>
                                <td>
                                    <span class="badge bg-light text-dark border">${item.count}ê°œ</span>
                                </td>
                                <td class="fw-bold text-danger">${itemTotal.toLocaleString()}ì›</td>
                                <td class="text-end pe-4">
                                    <button class="btn btn-sm btn-outline-secondary" onclick="deleteCartItem(${item.cartItemId})">ì‚­ì œ</button>
                                </td>
                            </tr>
                        `;
                        listBody.insertAdjacentHTML('beforeend', row);
                    });
                }

                // ì´ ê°€ê²© ì—…ë°ì´íŠ¸
                document.getElementById('total-price-display').innerText = totalPrice.toLocaleString() + "ì›";
                document.getElementById('final-price-display').innerText = totalPrice.toLocaleString() + "ì›";
            })
            .catch(err => {
                console.error(err);
                alert("ì¥ë°”êµ¬ë‹ˆ ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¤ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.");
            });
        }

        // 2. ì „ì²´ ì£¼ë¬¸í•˜ê¸° í•¨ìˆ˜
        function orderAll() {
            const token = localStorage.getItem('accessToken');
            
            // ì¥ë°”êµ¬ë‹ˆê°€ ë¹„ì–´ìˆëŠ”ì§€ í™”ë©´ì˜ ê°€ê²©ìœ¼ë¡œ í™•ì¸ (ê°„ë‹¨ ì²´í¬)
            const priceText = document.getElementById('final-price-display').innerText;
            if (priceText === "0ì›") {
                alert("ì¥ë°”êµ¬ë‹ˆê°€ ë¹„ì–´ìˆìŠµë‹ˆë‹¤.");
                return;
            }

            if (!confirm("ì¥ë°”êµ¬ë‹ˆì˜ ëª¨ë“  ìƒí’ˆì„ ì£¼ë¬¸í•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) {
                return;
            }

            // ì£¼ë¬¸ API í˜¸ì¶œ
            fetch('/api/cart/order', {
                method: 'POST',
                headers: {
                    'Authorization': 'Bearer ' + token,
                    'Content-Type': 'application/json'
                }
            })
            .then(res => {
                if (res.status === 401) {
                    alert("ì„¸ì…˜ì´ ë§Œë£Œë˜ì—ˆìŠµë‹ˆë‹¤.");
                    window.location.href = '/login.html';
                    return;
                }
                if (!res.ok) {
                    return res.text().then(text => { throw new Error(text) });
                }
                return res.text();
            })
            .then(msg => {
                alert(msg); // "ì£¼ë¬¸ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤!"
                window.location.href = '/'; // ë©”ì¸ìœ¼ë¡œ ì´ë™ (ì¶”í›„ ì£¼ë¬¸ë‚´ì—­ í˜ì´ì§€ë¡œ ë³€ê²½)
            })
            .catch(err => {
                console.error(err);
                alert("ì£¼ë¬¸ ì‹¤íŒ¨: " + err.message);
            });
        }

        // 3. ê°œë³„ ì‚­ì œ ë²„íŠ¼ í•¨ìˆ˜
        function deleteCartItem(cartItemId) {
            if(!confirm("ì •ë§ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) {
                return;
            }
            
            const token = localStorage.getItem('accessToken');
            
            fetch(`/api/cart/${cartItemId}`, { // PathVariableë¡œ ID ì „ë‹¬
                method: 'DELETE', // DELETE ë©”ì„œë“œ ì‚¬ìš©
                headers: {
                    'Authorization': 'Bearer ' + token
                }
            })
            .then(res => {
                if (res.status === 401) {
                    alert("ì„¸ì…˜ì´ ë§Œë£Œë˜ì—ˆìŠµë‹ˆë‹¤.");
                    window.location.href = '/login.html';
                    return;
                }
                if (!res.ok) {
                    return res.text().then(text => { throw new Error(text) });
                }
                return res.text();
            })
            .then(msg => {
                alert(msg); // "ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤."
                loadCart(); // ëª©ë¡ ìƒˆë¡œê³ ì¹¨ (í™”ë©´ ê°±ì‹ )
            })
            .catch(err => {
                console.error(err);
                alert("ì‚­ì œ ì‹¤íŒ¨: " + err.message);
            });
        }
    </script>
</body>
</html>