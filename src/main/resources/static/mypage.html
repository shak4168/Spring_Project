<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>ë§ˆì´í˜ì´ì§€ - ë‚´ ì£¼ë¬¸ ë‚´ì—­</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        .repImg {
            height: 100px;
            width: 100px;
            object-fit: cover;
        }
        .card {
            margin-bottom: 20px;
        }
        .fs-18 {
            font-size: 18px;
        }
        /* í˜ì´ì§€ë„¤ì´ì…˜ ì»¤ìŠ¤í…€ (í•„ìš”ì‹œ) */
        .page-link { cursor: pointer; }
    </style>
</head>
<body class="bg-light">

<nav class="navbar navbar-expand-lg navbar-dark bg-dark mb-4">
    <div class="container">
        <a class="navbar-brand fw-bold" href="/">Shop</a>
    </div>
</nav>

<div class="container">
    <h2 class="mb-4">ğŸ“¦ êµ¬ë§¤ ì´ë ¥</h2>

    <div id="order-list">
        <div class="text-center py-5">
            <div class="spinner-border text-primary" role="status"></div>
            <p>ì£¼ë¬¸ ë‚´ì—­ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</p>
        </div>
    </div>

    <nav aria-label="Page navigation" class="mt-4 mb-5">
        <ul class="pagination justify-content-center" id="pagination-area">
        </ul>
    </nav>
</div>

<div class="modal fade" id="reviewModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">ë¦¬ë·° ì‘ì„±</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <input type="hidden" id="modalItemId">
                
                <form id="reviewForm">
                    <div class="mb-3">
                        <label for="reviewRating" class="form-label">ë³„ì </label>
                        <select class="form-select" id="reviewRating">
                            <option value="5">â˜…â˜…â˜…â˜…â˜… (5ì )</option>
                            <option value="4">â˜…â˜…â˜…â˜… (4ì )</option>
                            <option value="3">â˜…â˜…â˜… (3ì )</option>
                            <option value="2">â˜…â˜… (2ì )</option>
                            <option value="1">â˜… (1ì )</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label for="reviewContent" class="form-label">ë‚´ìš©</label>
                        <textarea class="form-control" id="reviewContent" rows="3" placeholder="ì†”ì§í•œ í›„ê¸°ë¥¼ ë‚¨ê²¨ì£¼ì„¸ìš”." required></textarea>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">ì·¨ì†Œ</button>
                <button type="button" class="btn btn-primary" onclick="submitReview()">ë“±ë¡</button>
            </div>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

<script>
    document.addEventListener("DOMContentLoaded", () => {
        loadOrderHist(0); // ì²˜ìŒì—” 0í˜ì´ì§€ ë¡œë“œ
    });

    function loadOrderHist(page) {
        const token = localStorage.getItem('accessToken');
        if (!token) {
            alert("ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.");
            window.location.href = '/login.html';
            return;
        }

        // â˜… URLì— page íŒŒë¼ë¯¸í„° ì¶”ê°€ (?page=0, ?page=1 ...)
        fetch(`/api/orders?page=${page}`, {
            method: 'GET',
            headers: {
                'Authorization': 'Bearer ' + token
            } 
        })
        .then(res => {
            if (res.status === 401) {
                alert("ì„¸ì…˜ì´ ë§Œë£Œë˜ì—ˆìŠµë‹ˆë‹¤.");
                window.location.href = '/login.html';
                return;
            }
            return res.json();
        })
        .then(data => {
            //  ë°±ì—”ë“œì—ì„œ Page ê°ì²´ë¥¼ ë°˜í™˜í•˜ë¯€ë¡œ data.contentê°€ ì§„ì§œ ë¦¬ìŠ¤íŠ¸ì„
            const orders = data.content; 
            const listArea = document.getElementById('order-list');
            listArea.innerHTML = '';

            if (orders.length === 0) {
                listArea.innerHTML = '<div class="text-center py-5 text-muted"><h4>ì£¼ë¬¸ ë‚´ì—­ì´ ì—†ìŠµë‹ˆë‹¤.</h4></div>';
                document.getElementById('pagination-area').innerHTML = ''; // ë²„íŠ¼ë„ ì‚­ì œ
                return;
            }

            orders.forEach(order => {
                let orderItemsHtml = '';

                //  DTO í•„ë“œëª… í™•ì¸ í•„ìš” (orderItemDTOList ì¸ì§€ orderItemDtoList ì¸ì§€)
                order.orderItemDTOList.forEach(item => {
                    // ì´ë¯¸ì§€ ì—†ìœ¼ë©´ ë”ë¯¸ ì´ë¯¸ì§€ ì‚¬ìš© (ë°©ì–´ ì½”ë“œ)
                    const imgUrl = item.imageUrl ? `/images/${item.imageUrl}` : 'https://dummyimage.com/100x100/dee2e6/6c757d.jpg';
                    
                    // [Senior Tip] ë¦¬ë·° ë²„íŠ¼ ìƒì„± ë¡œì§ (ì¡°ê±´ë¶€ ë Œë”ë§)
                    // 1. ì£¼ë¬¸ ìƒíƒœê°€ 'ORDER(êµ¬ë§¤ì™„ë£Œ)' ì—¬ì•¼ í•¨.
                    // 2. item.hasReview ê°’ì„ í™•ì¸í•˜ì—¬ ë²„íŠ¼ ìƒíƒœ ê²°ì •.
                    let reviewBtnHtml = '';
                    
                    if (order.orderStatus === 'ORDER') {
                        if (item.hasReview) {
                            // [CASE A] ì´ë¯¸ ë¦¬ë·°ë¥¼ ì‘ì„±í•œ ê²½ìš° -> ë²„íŠ¼ ë¹„í™œì„±í™” (Disabled)
                            reviewBtnHtml = `<button class="btn btn-sm btn-secondary ms-auto" disabled>ì‘ì„± ì™„ë£Œ</button>`;
                        } else {
                            // [CASE B] ë¦¬ë·°ë¥¼ ì•„ì§ ì•ˆ ì“´ ê²½ìš° -> ë¦¬ë·° ì“°ê¸° ë²„íŠ¼ í™œì„±í™”
                            // í´ë¦­ ì‹œ openReviewModalì— ìƒí’ˆ IDë¥¼ ì „ë‹¬í•©ë‹ˆë‹¤.
                            reviewBtnHtml = `<button type="button" class="btn btn-sm btn-outline-primary ms-auto" onclick="openReviewModal(${item.itemId})">ë¦¬ë·° ì“°ê¸°</button>`;
                        }
                    }

                    orderItemsHtml += `
                        <div class="d-flex mb-3 align-items-center border-bottom pb-3">
                            <div class="flex-shrink-0">
                                <img src="${imgUrl}" class="repImg rounded" alt="${item.itemName}">
                            </div>
                            <div class="flex-grow-1 ms-3">
                                <div class="fs-18 font-weight-bold">${item.itemName}</div>
                                <div class="fs-18">
                                    <span class="text-danger">${item.orderPrice.toLocaleString()}ì›</span>
                                    <span class="text-muted ms-2">${item.count}ê°œ</span>
                                </div>
                            </div>
                            <div class="ms-3">
                                ${reviewBtnHtml}
                            </div>
                        </div>
                    `;
                });

                let cancelButton = '';
                if (order.orderStatus === 'ORDER') {
                    cancelButton = `<button type="button" class="btn btn-outline-secondary" onclick="cancelOrder(${order.orderId})">ì£¼ë¬¸ ì·¨ì†Œ</button>`;
                } else {
                    // ì·¨ì†Œ ì™„ë£Œëœ ì£¼ë¬¸ì€ ë²„íŠ¼ ë¹„í™œì„±í™”
                    cancelButton = `<button type="button" class="btn btn-outline-secondary" disabled>ì·¨ì†Œ ì™„ë£Œ</button>`;
                }

                const html = `
                    <div class="card shadow-sm border-0">
                        <div class="card-header bg-white d-flex justify-content-between align-items-center">
                            <h5 class="mb-0">${order.orderDate} <small class="text-muted">ì£¼ë¬¸</small></h5>
                            <div>${cancelButton}</div>
                        </div>
                        <div class="card-body">${orderItemsHtml}</div>
                    </div>
                `;
                listArea.insertAdjacentHTML('beforeend', html);
            });

            // â˜… í˜ì´ì§€ë„¤ì´ì…˜ ë²„íŠ¼ ê·¸ë¦¬ê¸° í•¨ìˆ˜ í˜¸ì¶œ
            renderPagination(data);
        })
        .catch(err => console.error(err));
    }

    // [í˜ì´ì§€ë„¤ì´ì…˜ ë²„íŠ¼ ê·¸ë¦¬ê¸° - 5ê°œì”© ëŠì–´ì„œ ë³´ì—¬ì£¼ê¸°]
    function renderPagination(pageData) {
        const paginationArea = document.getElementById('pagination-area');
        paginationArea.innerHTML = '';

        const totalPages = pageData.totalPages; // ì „ì²´ í˜ì´ì§€ ìˆ˜
        const currPage = pageData.number;       // í˜„ì¬ í˜ì´ì§€ (0ë¶€í„° ì‹œì‘)
        const blockLimit = 5;                   // í•œ ë²ˆì— ë³´ì—¬ì¤„ í˜ì´ì§€ ë²ˆí˜¸ ê°œìˆ˜

        if (totalPages <= 1) return;

        // ë³´ì—¬ì¤„ ì‹œì‘ í˜ì´ì§€ì™€ ë í˜ì´ì§€ ê³„ì‚°
        const startPage = Math.floor(currPage / blockLimit) * blockLimit;
        const endPage = Math.min(startPage + blockLimit, totalPages);

        // 1. <ì´ì „ ë¸”ë¡> ë²„íŠ¼
        const prevDisabled = (startPage === 0) ? 'disabled' : '';
        const prevPage = Math.max(0, startPage - 1); 
        
        let prevBtn = `
            <li class="page-item ${prevDisabled}">
                <a class="page-link" href="#" onclick="loadOrderHist(${prevPage}); return false;">ì´ì „</a>
            </li>`;
        paginationArea.insertAdjacentHTML('beforeend', prevBtn);

        // 2. í˜ì´ì§€ ë²ˆí˜¸ ë²„íŠ¼
        for (let i = startPage; i < endPage; i++) {
            let activeClass = (i === currPage) ? 'active' : '';
            let numBtn = `
                <li class="page-item ${activeClass}">
                    <a class="page-link" href="#" onclick="loadOrderHist(${i}); return false;">${i + 1}</a>
                </li>`;
            paginationArea.insertAdjacentHTML('beforeend', numBtn);
        }

        // 3. <ë‹¤ìŒ ë¸”ë¡> ë²„íŠ¼
        const nextDisabled = (endPage >= totalPages) ? 'disabled' : '';
        const nextPage = endPage; 
        
        let nextBtn = `
            <li class="page-item ${nextDisabled}">
                <a class="page-link" href="#" onclick="loadOrderHist(${nextPage}); return false;">ë‹¤ìŒ</a>
            </li>`;
        paginationArea.insertAdjacentHTML('beforeend', nextBtn);
    }

    // [ì£¼ë¬¸ ì·¨ì†Œ í•¨ìˆ˜] (ê¸°ì¡´ ë™ì¼)
    function cancelOrder(orderId) {
        if (!confirm("ì£¼ë¬¸ì„ ì·¨ì†Œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) return;
        const token = localStorage.getItem('accessToken');
        
        fetch(`/api/orders/${orderId}/cancel`, { 
            method: 'POST', 
            headers: {
                'Authorization': 'Bearer ' + token,
                'Content-Type': 'application/json'
            }
        })
        .then(res => {
            if(!res.ok) throw new Error("ì·¨ì†Œ ì‹¤íŒ¨");
            alert("ì£¼ë¬¸ì´ ì·¨ì†Œë˜ì—ˆìŠµë‹ˆë‹¤.");
            loadOrderHist(0); // ì²« í˜ì´ì§€ë¡œ ìƒˆë¡œê³ ì¹¨
        })
        .catch(err => alert(err.message));
    }

    // --- [Senior Tip] ë¦¬ë·° ê´€ë ¨ ê¸°ëŠ¥ ì¶”ê°€ ---

    // 1. ëª¨ë‹¬ ì—´ê¸° í•¨ìˆ˜ (ë¦¬ë·° ì“°ê¸° ë²„íŠ¼ í´ë¦­ ì‹œ ì‹¤í–‰)
    function openReviewModal(itemId) {
        // í´ë¦­í•œ ìƒí’ˆì˜ IDë¥¼ hidden inputì— ì €ì¥í•´ë‘¡ë‹ˆë‹¤. 
        // ê·¸ë˜ì•¼ ë‚˜ì¤‘ì— "ë“±ë¡" ë²„íŠ¼ì„ ëˆŒë €ì„ ë•Œ ì–´ë–¤ ìƒí’ˆ ë¦¬ë·°ì¸ì§€ ì•Œ ìˆ˜ ìˆìŠµë‹ˆë‹¤.
        document.getElementById('modalItemId').value = itemId; 
        
        // ì…ë ¥ì°½ ë‚´ìš©ì„ ê¹¨ë—í•˜ê²Œ ì´ˆê¸°í™”
        document.getElementById('reviewContent').value = '';   
        document.getElementById('reviewRating').value = '5';   
        
        // ë¶€íŠ¸ìŠ¤íŠ¸ë© ëª¨ë‹¬ ë„ìš°ê¸° ì½”ë“œ
        const modal = new bootstrap.Modal(document.getElementById('reviewModal'));
        modal.show();
    }

    // 2. ë¦¬ë·° ë“±ë¡ API í˜¸ì¶œ (ëª¨ë‹¬ ì•ˆì˜ ë“±ë¡ ë²„íŠ¼ í´ë¦­ ì‹œ ì‹¤í–‰)
    function submitReview() {
        const token = localStorage.getItem('accessToken');
        
        // hidden inputì— ì €ì¥í•´ë‘” itemIdë¥¼ ê°€ì ¸ì˜µë‹ˆë‹¤.
        const itemId = document.getElementById('modalItemId').value;
        const rating = document.getElementById('reviewRating').value;
        const content = document.getElementById('reviewContent').value;

        // ê°„ë‹¨í•œ ìœ íš¨ì„± ê²€ì‚¬
        if (!content.trim()) {
            alert("ë¦¬ë·° ë‚´ìš©ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.");
            return;
        }

        // ë°±ì—”ë“œ(ReviewRequestDTO) ìŠ¤í™ì— ë§ì¶° JSON ë°ì´í„° ì¤€ë¹„
        const data = {
            itemId: parseInt(itemId),
            rating: parseInt(rating),
            content: content
        };

        // API í˜¸ì¶œ
        fetch('/api/reviews', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'Authorization': 'Bearer ' + token
            },
            body: JSON.stringify(data)
        })
        .then(res => {
            // 403 Forbidden: "êµ¬ë§¤ í™•ì • ìƒí’ˆë§Œ..." ë˜ëŠ” "ì´ë¯¸ ì‘ì„±í•¨" ì—ëŸ¬ ì²˜ë¦¬
            if (!res.ok) {
                return res.text().then(msg => { throw new Error(msg); });
            }
            return res.text();
        })
        .then(() => {
            alert("ë¦¬ë·°ê°€ ë“±ë¡ë˜ì—ˆìŠµë‹ˆë‹¤!");
            
            // ëª¨ë‹¬ ë‹«ê¸°
            const modalEl = document.getElementById('reviewModal');
            // ì´ë¯¸ ì—´ë ¤ìˆëŠ” ëª¨ë‹¬ ì¸ìŠ¤í„´ìŠ¤ë¥¼ ê°€ì ¸ì™€ì„œ ë‹«ìŒ
            const modal = bootstrap.Modal.getInstance(modalEl);
            modal.hide();

            // [ì¤‘ìš”] ëª©ë¡ ìƒˆë¡œê³ ì¹¨ 
            // ìƒˆë¡œê³ ì¹¨ì„ í•´ì•¼ ë°±ì—”ë“œì—ì„œ ê°±ì‹ ëœ hasReview ê°’ì„ ë‹¤ì‹œ ë°›ì•„ì™€ì„œ
            // ë²„íŠ¼ì´ 'ì‘ì„± ì™„ë£Œ'ë¡œ ë°”ë€ë‹ˆë‹¤.
            loadOrderHist(0); 
        })
        .catch(err => {
            // ë°±ì—”ë“œì—ì„œ ë³´ë‚¸ ì—ëŸ¬ ë©”ì‹œì§€ë¥¼ alert ì°½ì— ë„ì›€
            alert(err.message);
        });
    }
</script>

</body>
</html>