<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>ë§ˆì´í˜ì´ì§€ - Cloud Native Shop</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css">
    
    <style>
        .repImg {
            height: 80px;
            width: 80px;
            object-fit: cover;
        }
        .sidebar-card {
            border: none;
            background-color: #f8f9fa;
        }
        .menu-item {
            cursor: pointer;
            transition: all 0.2s;
        }
        .menu-item:hover, .menu-item.active {
            background-color: #e9ecef;
            color: #0d6efd;
            font-weight: bold;
        }
        .seller-promo {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }
    </style>
</head>
<body class="bg-light">

<nav class="navbar navbar-expand-lg navbar-dark bg-dark mb-4">
    <div class="container">
        <a class="navbar-brand fw-bold" href="/">Cloud Shop</a>
        <div class="d-flex">
            <button class="btn btn-outline-light btn-sm" onclick="logout()">ë¡œê·¸ì•„ì›ƒ</button>
        </div>
    </div>
</nav>

<div class="container">
    <div class="row">
        <div class="col-md-3 mb-4">
            <div class="card sidebar-card shadow-sm mb-3">
                <div class="card-body text-center py-4">
                    <div class="mb-3">
                        <i class="bi bi-person-circle display-4 text-secondary"></i>
                    </div>
                    <h5 class="fw-bold" id="profile-name">ì‚¬ìš©ìë‹˜</h5>
                    <p class="text-muted small mb-0" id="profile-email">user@example.com</p>
                    <span class="badge bg-secondary mt-2" id="profile-role">êµ¬ë§¤ì</span>
                </div>
            </div>

            <div class="list-group shadow-sm mb-4">
                <a class="list-group-item list-group-item-action menu-item active" onclick="switchTab('orders', this)">
                    <i class="bi bi-box-seam me-2"></i> êµ¬ë§¤ ë‚´ì—­
                </a>
                <a class="list-group-item list-group-item-action menu-item" onclick="switchTab('info', this)">
                    <i class="bi bi-gear me-2"></i> ë‚´ ì •ë³´ ìˆ˜ì •
                </a>
            </div>

            <div id="seller-promo-card" class="card seller-promo shadow border-0 d-none">
                <div class="card-body text-center">
                    <h5 class="fw-bold mb-2">íŒë§¤ìê°€ ë˜ì–´ë³´ì„¸ìš”!</h5>
                    <p class="small opacity-75 mb-3">ë‚˜ë§Œì˜ ìƒí’ˆì„ ë“±ë¡í•˜ê³  íŒë§¤í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</p>
                    <button onclick="requestSeller()" class="btn btn-light btn-sm w-100 fw-bold text-primary">
                        íŒë§¤ì ê¶Œí•œ ì‹ ì²­
                    </button>
                </div>
            </div>
        </div>

        <div class="col-md-9">
            
            <div id="section-orders">
                <h4 class="fw-bold mb-3 border-bottom pb-2">ğŸ“¦ êµ¬ë§¤ ë‚´ì—­</h4>
                <div id="order-list">
                    <div class="text-center py-5">
                        <div class="spinner-border text-primary" role="status"></div>
                    </div>
                </div>
                <nav aria-label="Page navigation" class="mt-4">
                    <ul class="pagination justify-content-center" id="pagination-area"></ul>
                </nav>
            </div>

            <div id="section-info" class="d-none">
                <h4 class="fw-bold mb-3 border-bottom pb-2">âš™ï¸ ë‚´ ì •ë³´ ìˆ˜ì •</h4>
                <div class="card shadow-sm border-0">
                    <div class="card-body p-4">
                        <form id="infoForm">
                            <div class="mb-3">
                                <label class="form-label text-muted">ì´ë©”ì¼ (ë³€ê²½ ë¶ˆê°€)</label>
                                <input type="text" id="info-email" class="form-control" readonly disabled>
                            </div>
                            <div class="mb-3">
                                <label class="form-label">ì´ë¦„</label>
                                <input type="text" id="info-name" class="form-control">
                            </div>
                            <div class="mb-3">
                                <label class="form-label">ë¹„ë°€ë²ˆí˜¸ ë³€ê²½</label>
                                <input type="password" id="info-password" class="form-control" placeholder="ë³€ê²½í•˜ë ¤ë©´ ì…ë ¥í•˜ì„¸ìš” (ë¹„ì›Œë‘ë©´ ìœ ì§€)">
                            </div>
                            
                            <hr class="my-4">
                            
                            <div class="row">
                                <div class="col-md-6 mb-3">
                                    <label class="form-label">ìš°í¸ë²ˆí˜¸</label>
                                    <div class="input-group">
                                        <input type="text" id="info-zipcode" class="form-control" readonly>
                                        <button class="btn btn-outline-secondary" type="button" onclick="execDaumPostcode()">ê²€ìƒ‰</button>
                                    </div>
                                </div>
                            </div>
                            <div class="mb-3">
                                <label class="form-label">ì£¼ì†Œ</label>
                                <input type="text" id="info-address" class="form-control" readonly>
                            </div>
                            <div class="mb-3">
                                <label class="form-label">ìƒì„¸ ì£¼ì†Œ</label>
                                <input type="text" id="info-detail" class="form-control">
                            </div>

                            <button type="button" onclick="updateInfo()" class="btn btn-primary w-100 py-2 mt-3">ìˆ˜ì • ì™„ë£Œ</button>
                        </form>
                    </div>
                </div>
            </div>

        </div>
    </div>
</div>

<div class="modal fade" id="reviewModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">ë¦¬ë·° ì‘ì„±</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <input type="hidden" id="modalItemId">
                <div class="mb-3">
                    <label class="form-label">ë³„ì </label>
                    <select class="form-select" id="reviewRating">
                        <option value="5">â˜…â˜…â˜…â˜…â˜… (5ì )</option>
                        <option value="4">â˜…â˜…â˜…â˜… (4ì )</option>
                        <option value="3">â˜…â˜…â˜… (3ì )</option>
                    </select>
                </div>
                <div class="mb-3">
                    <label class="form-label">ë‚´ìš©</label>
                    <textarea class="form-control" id="reviewContent" rows="3"></textarea>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">ì·¨ì†Œ</button>
                <button type="button" class="btn btn-primary" onclick="submitReview()">ë“±ë¡</button>
            </div>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script src="//t1.daumcdn.net/mapjsapi/bundle/postcode/prod/postcode.v2.js"></script>

<script>
    // í˜ì´ì§€ ë¡œë“œ ì‹œ ì‹¤í–‰
    document.addEventListener("DOMContentLoaded", () => {
        loadMyInfo();      // 1. ë‚´ ì •ë³´(ì‚¬ì´ë“œë°”, ìˆ˜ì •í¼) ì±„ìš°ê¸°
        loadOrderHist(0);  // 2. ì£¼ë¬¸ ë‚´ì—­ ë¶ˆëŸ¬ì˜¤ê¸°
    });

    // ==========================================
    // 1. íƒ­ ì „í™˜ ê¸°ëŠ¥ (SPA ëŠë‚Œ)
    // ==========================================
    function switchTab(tabName, element) {
        // ëª¨ë“  íƒ­ ìˆ¨ê¸°ê¸°
        document.getElementById('section-orders').classList.add('d-none');
        document.getElementById('section-info').classList.add('d-none');
        
        // ì„ íƒí•œ íƒ­ ë³´ì´ê¸°
        document.getElementById('section-' + tabName).classList.remove('d-none');

        // ë©”ë‰´ í™œì„±í™” ìŠ¤íƒ€ì¼ ë³€ê²½
        const menus = document.querySelectorAll('.menu-item');
        menus.forEach(m => m.classList.remove('active'));
        if(element) element.classList.add('active');
    }

    // ==========================================
    // 2. ë‚´ ì •ë³´ ì¡°íšŒ ë° íŒë§¤ì ë°°ë„ˆ ì²˜ë¦¬
    // ==========================================
    async function loadMyInfo() {
        const token = localStorage.getItem('accessToken');
        if (!token) {
            location.href = '/login.html';
            return;
        }

        try {
            const res = await fetch('/api/members/me', {
                headers: { 'Authorization': 'Bearer ' + token }
            });
            
            if (res.ok) {
                const member = await res.json();
                
                // ì‚¬ì´ë“œë°” ì •ë³´ ì±„ìš°ê¸°
                document.getElementById('profile-name').innerText = member.name;
                document.getElementById('profile-email').innerText = member.email;
                document.getElementById('profile-role').innerText = member.role === 'ADMIN' ? 'ê´€ë¦¬ì' : (member.role === 'SELLER' ? 'íŒë§¤ì' : 'êµ¬ë§¤ì');
                
                // ìˆ˜ì • í¼ ì •ë³´ ì±„ìš°ê¸°
                document.getElementById('info-email').value = member.email;
                document.getElementById('info-name').value = member.name;
                document.getElementById('info-zipcode').value = member.zipcode || '';
                document.getElementById('info-address').value = member.address || '';
                document.getElementById('info-detail').value = member.detailAddress || '';

                // â˜… íŒë§¤ì ì‹ ì²­ ë°°ë„ˆ ë¡œì§
                // ê¶Œí•œì´ USERì¸ ê²½ìš°ì—ë§Œ ë°°ë„ˆë¥¼ ë³´ì—¬ì¤ë‹ˆë‹¤.
                if (member.role === 'USER') {
                    document.getElementById('seller-promo-card').classList.remove('d-none');
                }
            }
        } catch (e) {
            console.error(e);
        }
    }

    // ==========================================
    // 3. íŒë§¤ì ê¶Œí•œ ì‹ ì²­ (ì‚¬ì´ë“œë°” ë²„íŠ¼)
    // ==========================================
    async function requestSeller() {
        if(!confirm("íŒë§¤ì ê¶Œí•œì„ ì‹ ì²­í•˜ì‹œê² ìŠµë‹ˆê¹Œ?\nê´€ë¦¬ì ìŠ¹ì¸ í›„ ìƒí’ˆ ë“±ë¡ì´ ê°€ëŠ¥í•©ë‹ˆë‹¤.")) return;

        const token = localStorage.getItem('accessToken');
        try {
            // [API í•„ìš”] POST /api/seller-requests
            // (ë§Œì•½ ì•„ì§ APIê°€ ì—†ë‹¤ë©´ MemberControllerì— ê°„ë‹¨íˆ ì¶”ê°€í•´ì•¼ í•¨)
            const res = await fetch('/api/seller-requests', {
                method: 'POST',
                headers: { 'Authorization': 'Bearer ' + token }
            });

            if (res.ok) {
                alert("ì‹ ì²­ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.\nê´€ë¦¬ì ìŠ¹ì¸ì„ ê¸°ë‹¤ë ¤ì£¼ì„¸ìš”.");
            } else {
                const msg = await res.text();
                alert("ì‹ ì²­ ì‹¤íŒ¨: " + msg); // "ì´ë¯¸ ì‹ ì²­í–ˆìŠµë‹ˆë‹¤" ë“±ì˜ ë©”ì‹œì§€
            }
        } catch (e) {
            console.error(e);
            alert("ì„œë²„ ì˜¤ë¥˜");
        }
    }

    // ==========================================
    // 4. ë‚´ ì •ë³´ ìˆ˜ì • ìš”ì²­
    // ==========================================
    async function updateInfo() {
        if(!confirm("ì •ë³´ë¥¼ ìˆ˜ì •í•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) return;
        
        const token = localStorage.getItem('accessToken');
        const data = {
            name: document.getElementById('info-name').value,
            password: document.getElementById('info-password').value, // ë¹„ì–´ìˆìœ¼ë©´ ë°±ì—”ë“œì—ì„œ ë¬´ì‹œí•˜ë„ë¡ ì²˜ë¦¬ í•„ìš”
            zipcode: document.getElementById('info-zipcode').value,
            address: document.getElementById('info-address').value,
            detailAddress: document.getElementById('info-detail').value
        };

        try {
            const res = await fetch('/api/members/me', {
                method: 'PUT', // or PATCH
                headers: { 
                    'Content-Type': 'application/json',
                    'Authorization': 'Bearer ' + token 
                },
                body: JSON.stringify(data)
            });

            if(res.ok) {
                alert("ìˆ˜ì •ë˜ì—ˆìŠµë‹ˆë‹¤.");
                location.reload(); // ì •ë³´ ê°±ì‹ ì„ ìœ„í•´ ìƒˆë¡œê³ ì¹¨
            } else {
                alert("ìˆ˜ì • ì‹¤íŒ¨");
            }
        } catch(e) {
            console.error(e);
        }
    }

    // ==========================================
    // 5. ì£¼ë¬¸ ë‚´ì—­ ì¡°íšŒ (ê¸°ì¡´ ë¡œì§ ìœ ì§€)
    // ==========================================
    function loadOrderHist(page) {
        const token = localStorage.getItem('accessToken');
        
        fetch(`/api/orders?page=${page}`, {
            method: 'GET',
            headers: { 'Authorization': 'Bearer ' + token } 
        })
        .then(res => res.json())
        .then(data => {
            const orders = data.content; 
            const listArea = document.getElementById('order-list');
            listArea.innerHTML = '';

            if (orders.length === 0) {
                listArea.innerHTML = '<div class="text-center py-5 text-muted"><h4>ì£¼ë¬¸ ë‚´ì—­ì´ ì—†ìŠµë‹ˆë‹¤.</h4></div>';
                document.getElementById('pagination-area').innerHTML = '';
                return;
            }

            orders.forEach(order => {
                let orderItemsHtml = '';
                
                order.orderItemDTOList.forEach(item => {
                    const imgUrl = item.imageUrl ? `/images/${item.imageUrl}` : 'https://dummyimage.com/100x100/dee2e6/6c757d.jpg';
                    
                    let reviewBtnHtml = '';
                    if (order.orderStatus === 'ORDER') {
                        if (item.hasReview) {
                            reviewBtnHtml = `<button class="btn btn-sm btn-secondary ms-auto" disabled>ì‘ì„± ì™„ë£Œ</button>`;
                        } else {
                            reviewBtnHtml = `<button type="button" class="btn btn-sm btn-outline-primary ms-auto" onclick="openReviewModal(${item.itemId})">ë¦¬ë·° ì“°ê¸°</button>`;
                        }
                    }

                    orderItemsHtml += `
                        <div class="d-flex mb-3 align-items-center border-bottom pb-3">
                            <div class="flex-shrink-0">
                                <img src="${imgUrl}" class="repImg rounded" alt="${item.itemName}">
                            </div>
                            <div class="flex-grow-1 ms-3">
                                <div class="fw-bold">${item.itemName}</div>
                                <div>
                                    <span class="text-danger fw-bold">${item.orderPrice.toLocaleString()}ì›</span>
                                    <span class="text-muted ms-1">${item.count}ê°œ</span>
                                </div>
                            </div>
                            <div class="ms-3">${reviewBtnHtml}</div>
                        </div>
                    `;
                });

                let cancelButton = order.orderStatus === 'ORDER' ? 
                    `<button class="btn btn-sm btn-outline-danger" onclick="cancelOrder(${order.orderId})">ì£¼ë¬¸ ì·¨ì†Œ</button>` : 
                    `<span class="badge bg-secondary">ì·¨ì†Œë¨</span>`;

                const html = `
                    <div class="card shadow-sm border-0 mb-3">
                        <div class="card-header bg-white d-flex justify-content-between align-items-center">
                            <span class="fw-bold">${order.orderDate}</span>
                            ${cancelButton}
                        </div>
                        <div class="card-body">${orderItemsHtml}</div>
                    </div>
                `;
                listArea.insertAdjacentHTML('beforeend', html);
            });
            renderPagination(data);
        });
    }

    // ì£¼ì†Œ ì°¾ê¸° (Daum API)
    function execDaumPostcode() {
        new daum.Postcode({
            oncomplete: function(data) {
                var addr = data.userSelectedType === 'R' ? data.roadAddress : data.jibunAddress;
                document.getElementById('info-zipcode').value = data.zonecode;
                document.getElementById("info-address").value = addr;
                document.getElementById("info-detail").focus();
            }
        }).open();
    }
    
    // í˜ì´ì§€ë„¤ì´ì…˜, ì£¼ë¬¸ì·¨ì†Œ, ë¦¬ë·° ê´€ë ¨ í•¨ìˆ˜ë“¤ì€ ê¸°ì¡´ê³¼ ë™ì¼í•˜ë¯€ë¡œ ìƒëµí•˜ì§€ ì•Šê³  
    // ì‹¤ì œ ì‚¬ìš© ì‹œì—ëŠ” ì´ì „ì— ì‘ì„±í•´ì£¼ì‹  í•¨ìˆ˜ë“¤(renderPagination, cancelOrder, openReviewModal, submitReview)ì„
    // ê·¸ëŒ€ë¡œ ë³µì‚¬í•´ì„œ ì—¬ê¸°ì— ë„£ìœ¼ì…”ì•¼ í•©ë‹ˆë‹¤! (ìœ„ ì½”ë“œì—ëŠ” ì¼ë¶€ ìƒëµë¨)
    
    // [ì¤‘ìš”] ê¸°ì¡´ í•¨ìˆ˜ë“¤ (ë³µë¶™ìš©)
    function renderPagination(pageData) { /* ... ì´ì „ ì½”ë“œ ì°¸ì¡° ... */ }
    function cancelOrder(orderId) { /* ... ì´ì „ ì½”ë“œ ì°¸ì¡° ... */ }
    function openReviewModal(itemId) {
        document.getElementById('modalItemId').value = itemId;
        document.getElementById('reviewContent').value = '';
        const modal = new bootstrap.Modal(document.getElementById('reviewModal'));
        modal.show();
    }
    function submitReview() {
         const token = localStorage.getItem('accessToken');
         const itemId = document.getElementById('modalItemId').value;
         const rating = document.getElementById('reviewRating').value;
         const content = document.getElementById('reviewContent').value;
         
         fetch('/api/reviews', {
             method: 'POST',
             headers: {'Content-Type': 'application/json', 'Authorization': 'Bearer ' + token},
             body: JSON.stringify({itemId, rating, content})
         }).then(res => {
             if(res.ok) { alert('ë“±ë¡ë˜ì—ˆìŠµë‹ˆë‹¤.'); location.reload(); }
             else alert('ë“±ë¡ ì‹¤íŒ¨');
         });
    }
    
    function logout() {
        localStorage.clear();
        location.href = '/';
    }
</script>

</body>
</html>