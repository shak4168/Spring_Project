<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>ë§ˆì´í˜ì´ì§€ - ë‚´ ì£¼ë¬¸ ë‚´ì—­</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        .repImg {
            height: 100px;
            width: 100px;
            object-fit: cover;
        }
        .card {
            margin-bottom: 20px;
        }
        .fs-18 {
            font-size: 18px;
        }
        /* í˜ì´ì§€ë„¤ì´ì…˜ ì»¤ìŠ¤í…€ (í•„ìš”ì‹œ) */
        .page-link { cursor: pointer; }
    </style>
</head>
<body class="bg-light">

<nav class="navbar navbar-expand-lg navbar-dark bg-dark mb-4">
    <div class="container">
        <a class="navbar-brand fw-bold" href="/">Shop</a>
    </div>
</nav>

<div class="container">
    <h2 class="mb-4">ğŸ“¦ êµ¬ë§¤ ì´ë ¥</h2>

    <div id="order-list">
        <div class="text-center py-5">
            <div class="spinner-border text-primary" role="status"></div>
            <p>ì£¼ë¬¸ ë‚´ì—­ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</p>
        </div>
    </div>

    <nav aria-label="Page navigation" class="mt-4">
        <ul class="pagination justify-content-center" id="pagination-area">
            </ul>
    </nav>
</div>

<script>
    document.addEventListener("DOMContentLoaded", () => {
        loadOrderHist(0); // ì²˜ìŒì—” 0í˜ì´ì§€ ë¡œë“œ
    });

    function loadOrderHist(page) {
        const token = localStorage.getItem('accessToken');
        if (!token) {
            alert("ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.");
            window.location.href = '/login.html';
            return;
        }

        // â˜… URLì— page íŒŒë¼ë¯¸í„° ì¶”ê°€ (?page=0, ?page=1 ...)
        fetch(`/api/orders?page=${page}`, {
            method: 'GET',
            headers: {
                'Authorization': 'Bearer ' + token
            } 
        })
        .then(res => {
            if (res.status === 401) {
                alert("ì„¸ì…˜ì´ ë§Œë£Œë˜ì—ˆìŠµë‹ˆë‹¤.");
                window.location.href = '/login.html';
                return;
            }
            return res.json();
        })
        .then(data => {
            //  ë°±ì—”ë“œì—ì„œ Page ê°ì²´ë¥¼ ë°˜í™˜í•˜ë¯€ë¡œ data.contentê°€ ì§„ì§œ ë¦¬ìŠ¤íŠ¸ì„
            const orders = data.content; 
            const listArea = document.getElementById('order-list');
            listArea.innerHTML = '';

            if (orders.length === 0) {
                listArea.innerHTML = '<div class="text-center py-5 text-muted"><h4>ì£¼ë¬¸ ë‚´ì—­ì´ ì—†ìŠµë‹ˆë‹¤.</h4></div>';
                document.getElementById('pagination-area').innerHTML = ''; // ë²„íŠ¼ë„ ì‚­ì œ
                return;
            }

            orders.forEach(order => {
                let orderItemsHtml = '';

                //  DTO í•„ë“œëª… í™•ì¸ í•„ìš” (orderItemDTOList ì¸ì§€ orderItemDtoList ì¸ì§€)
                // Javaì—ì„œ List<OrderItemDTO> orderItemDTOList ë¼ê³  í–ˆìœ¼ë©´ getterëŠ” getOrderItemDTOList() -> JSONì€ orderItemDTOList
                order.orderItemDTOList.forEach(item => {
                    const imgUrl = item.imageUrl ? `/images/${item.imageUrl}` : 'https://dummyimage.com/100x100/dee2e6/6c757d.jpg';
                    
                    orderItemsHtml += `
                        <div class="d-flex mb-3">
                            <div class="flex-shrink-0">
                                <img src="${imgUrl}" class="repImg rounded" alt="${item.itemName}">
                            </div>
                            <div class="flex-grow-1 ms-3">
                                <div class="fs-18 font-weight-bold">${item.itemName}</div>
                                <div class="fs-18">
                                    <span class="text-danger">${item.orderPrice.toLocaleString()}ì›</span>
                                    <span class="text-muted ms-2">${item.count}ê°œ</span>
                                </div>
                            </div>
                        </div>
                    `;
                });

                let cancelButton = '';
                if (order.orderStatus === 'ORDER') {
                    cancelButton = `<button type="button" class="btn btn-outline-secondary" onclick="cancelOrder(${order.orderId})">ì£¼ë¬¸ ì·¨ì†Œ</button>`;
                } else {
                    cancelButton = `<button type="button" class="btn btn-outline-secondary" disabled>ì·¨ì†Œ ì™„ë£Œ</button>`;
                }

                const html = `
                    <div class="card shadow-sm border-0">
                        <div class="card-header bg-white d-flex justify-content-between align-items-center">
                            <h5 class="mb-0">${order.orderDate} <small class="text-muted">ì£¼ë¬¸</small></h5>
                            <div>${cancelButton}</div>
                        </div>
                        <div class="card-body">${orderItemsHtml}</div>
                    </div>
                `;
                listArea.insertAdjacentHTML('beforeend', html);
            });

            // â˜… í˜ì´ì§€ë„¤ì´ì…˜ ë²„íŠ¼ ê·¸ë¦¬ê¸° í•¨ìˆ˜ í˜¸ì¶œ
            renderPagination(data);
        })
        .catch(err => console.error(err));
    }

 // [í˜ì´ì§€ë„¤ì´ì…˜ ë²„íŠ¼ ê·¸ë¦¬ê¸° - 5ê°œì”© ëŠì–´ì„œ ë³´ì—¬ì£¼ê¸°]
    function renderPagination(pageData) {
        const paginationArea = document.getElementById('pagination-area');
        paginationArea.innerHTML = '';

        const totalPages = pageData.totalPages; // ì „ì²´ í˜ì´ì§€ ìˆ˜
        const currPage = pageData.number;       // í˜„ì¬ í˜ì´ì§€ (0ë¶€í„° ì‹œì‘)
        const blockLimit = 5;                   // í•œ ë²ˆì— ë³´ì—¬ì¤„ í˜ì´ì§€ ë²ˆí˜¸ ê°œìˆ˜

        if (totalPages <= 1) return;

        // ë³´ì—¬ì¤„ ì‹œì‘ í˜ì´ì§€ì™€ ë í˜ì´ì§€ ê³„ì‚°
        // ì˜ˆ: í˜„ì¬ 7í˜ì´ì§€(index 6)ë¼ë©´, startPageëŠ” 5, endPageëŠ” 10ì´ ë¨
        const startPage = Math.floor(currPage / blockLimit) * blockLimit;
        const endPage = Math.min(startPage + blockLimit, totalPages);

        // 1. <ì´ì „ ë¸”ë¡> ë²„íŠ¼ (ì²« ë¸”ë¡ì´ë©´ ë¹„í™œì„±í™”ê°€ ì•„ë‹ˆë¼ ì•„ì˜ˆ ìˆ¨ê¹€ or ë¹„í™œì„±)
        // 0í˜ì´ì§€ê°€ ì•„ë‹ˆë¼ í˜„ì¬ ë¸”ë¡ì˜ ì‹œì‘ë³´ë‹¤ ì•ìª½ìœ¼ë¡œ ê°€ì•¼ í•¨
        const prevDisabled = (startPage === 0) ? 'disabled' : '';
        const prevPage = Math.max(0, startPage - 1); // ì´ì „ ë¸”ë¡ì˜ ë§ˆì§€ë§‰ í˜ì´ì§€ë¡œ ì´ë™
        
        let prevBtn = `
            <li class="page-item ${prevDisabled}">
                <a class="page-link" href="#" onclick="loadOrderHist(${prevPage}); return false;">ì´ì „</a>
            </li>`;
        paginationArea.insertAdjacentHTML('beforeend', prevBtn);

        // 2. í˜ì´ì§€ ë²ˆí˜¸ ë²„íŠ¼ (startPage ~ endPage ê¹Œì§€ë§Œ ë°˜ë³µ)
        for (let i = startPage; i < endPage; i++) {
            let activeClass = (i === currPage) ? 'active' : '';
            let numBtn = `
                <li class="page-item ${activeClass}">
                    <a class="page-link" href="#" onclick="loadOrderHist(${i}); return false;">${i + 1}</a>
                </li>`;
            paginationArea.insertAdjacentHTML('beforeend', numBtn);
        }

        // 3. <ë‹¤ìŒ ë¸”ë¡> ë²„íŠ¼
        const nextDisabled = (endPage >= totalPages) ? 'disabled' : '';
        const nextPage = endPage; // ë‹¤ìŒ ë¸”ë¡ì˜ ì²« í˜ì´ì§€ë¡œ ì´ë™
        
        let nextBtn = `
            <li class="page-item ${nextDisabled}">
                <a class="page-link" href="#" onclick="loadOrderHist(${nextPage}); return false;">ë‹¤ìŒ</a>
            </li>`;
        paginationArea.insertAdjacentHTML('beforeend', nextBtn);
    }

    // [ì£¼ë¬¸ ì·¨ì†Œ í•¨ìˆ˜] (ê¸°ì¡´ ë™ì¼)
    function cancelOrder(orderId) {
        if (!confirm("ì£¼ë¬¸ì„ ì·¨ì†Œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) return;
        const token = localStorage.getItem('accessToken');
        
        fetch(`/api/orders/${orderId}/cancel`, { // API ì£¼ì†Œ í™•ì¸ í•„ìš”
            method: 'POST', // or DELETE/PATCH
            headers: {
                'Authorization': 'Bearer ' + token,
                'Content-Type': 'application/json'
            }
        })
        .then(res => {
            if(!res.ok) throw new Error("ì·¨ì†Œ ì‹¤íŒ¨");
            alert("ì£¼ë¬¸ì´ ì·¨ì†Œë˜ì—ˆìŠµë‹ˆë‹¤.");
            loadOrderHist(0); // ì²« í˜ì´ì§€ë¡œ ìƒˆë¡œê³ ì¹¨
        })
        .catch(err => alert(err.message));
    }
</script>

</body>
</html>