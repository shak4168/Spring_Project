events {
    worker_connections 1024;
}

http {
    include       mime.types;
    default_type  application/octet-stream;

    # 1. 불필요한 연결 맺기/끊기 비용 절감 (Keep-Alive)
    # 문을 매번 닫지 않고 65초 동안 열어둡니다. (CPU 절약)
    keepalive_timeout 65;

    # 2. 정적 리소스 압축 (Gzip)
    # 데이터를 zip으로 압축해서 보내서 전송 속도를 높입니다.
    gzip on;
    gzip_types text/plain application/xml text/css application/javascript application/json;
    gzip_min_length 1000;

    # 3. 백엔드와의 연결 최적화 (Upstream Keep-Alive)
    upstream spring-backend {
        server backend:8081; # 도커 내부 주소
        keepalive 32;        # 백엔드랑 연결된 전화기도 끊지 말고 들고 있어라
    }

    server {
        listen 80;
        server_name localhost;

        location / {
            proxy_pass http://spring-backend;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            
            # 백엔드 연결 유지 설정 (필수)
            proxy_http_version 1.1;
            proxy_set_header Connection "";
        }
    }
}